<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªæ´»å‹•è¨˜éŒ² v3.5 (2025/12/28 13:30)</title>
<style>
:root{
  --ink:#111827;--muted:#6b7280;--bg:#f2f2f7;--card:#fff;
  --line:#c6c6c8;--brand:#007aff;--chip:#f2f2f7;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;overscroll-behavior:none}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  color:var(--ink);background:var(--bg);
  padding-bottom:calc(60px + var(--safe-bottom));
}
header{
  position:sticky;top:0;z-index:100;
  background:rgba(242,242,247,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:0.5px solid var(--line);
  padding:calc(12px + var(--safe-top)) 16px 12px;
}
h1{margin:0;font-size:17px;font-weight:600;text-align:center}
.sub{margin:4px 0 0;color:var(--muted);font-size:12px;text-align:center}
main{padding:12px}
.card{
  background:#fff;border-radius:12px;
  margin-bottom:12px;overflow:hidden;
}
.card-header{
  padding:14px 16px 10px;
  font-size:15px;font-weight:600;
  border-bottom:0.5px solid var(--line);
}
.card-body{padding:12px 16px}
h3{margin:12px 0 8px;font-size:13px;color:var(--muted);font-weight:500}
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 4px}
input,textarea,select{
  width:100%;padding:12px;
  border:none;border-radius:10px;
  background:var(--chip);font-size:16px;
  -webkit-appearance:none;
}
textarea{resize:none;min-height:80px}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.time-row{display:flex;gap:8px;align-items:center}
.time-row input{flex:1}
.time-btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:8px;
  padding:12px 14px;font-size:14px;font-weight:500;
  white-space:nowrap;
}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.chip{
  background:var(--chip);border:1.5px solid transparent;
  border-radius:20px;padding:8px 14px;
  font-size:14px;font-weight:500;
  user-select:none;cursor:pointer;
  transition:all 0.15s;
}
.chip:active{transform:scale(0.95)}
.chip[data-state="on"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="+"]{background:#fee2e2;border-color:#f87171;color:#b91c1c}
.chip[data-state="-"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="proc"]{background:var(--brand);color:#fff}
.btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:10px;
  padding:14px 20px;font-size:15px;font-weight:600;
  width:100%;
}
.btn:active{opacity:0.8}
.btn.ghost{background:var(--chip);color:var(--ink)}
.btn.small{padding:10px 16px;font-size:14px}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-row .btn{flex:1}

.toggle-btn{
  background:var(--chip);
  border:1.5px solid var(--line);
  border-radius:10px;
  padding:10px 16px;
  font-size:15px;font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
  user-select:none;
}
.toggle-btn:active{transform:scale(0.97)}
.toggle-btn.active{
  background:#dcfce7;
  border-color:#4ade80;
  color:#15803d;
}

@keyframes checkFlash {
  0% { background: transparent; }
  50% { background: rgba(0, 122, 255, 0.15); }
  100% { background: transparent; }
}
.check-flash {
  animation: checkFlash 0.4s ease-out;
  border-radius: 8px;
}

.vital-card{
  background:#fff;border-radius:12px;
  margin-top:10px;overflow:hidden;
  border:1px solid var(--line);
}
.vital-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 14px;background:#f9fafb;
  border-bottom:0.5px solid var(--line);
}
.vital-time{
  display:flex;align-items:center;gap:8px;
}
.vital-time input{
  width:100px;padding:8px 10px;
  font-size:15px;font-weight:600;
  color:var(--brand);background:#fff;
  border:1px solid var(--line);border-radius:8px;
}
.vital-del{
  background:#fee2e2;color:#dc2626;
  border:none;border-radius:8px;
  padding:8px 12px;font-size:13px;font-weight:500;
}
.vital-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:1px;background:var(--line);
}
.vital-item{
  background:#fff;padding:10px 8px;
  text-align:center;cursor:pointer;
  transition:background 0.15s;
}
.vital-item:active{background:#f3f4f6}
.vital-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.vital-value{font-size:20px;font-weight:600;color:var(--ink)}
.vital-unit{font-size:11px;color:var(--muted)}
.vital-gcs{
  grid-column:span 3;
  display:flex;justify-content:center;gap:20px;
  padding:12px;
}
.gcs-part{text-align:center;cursor:pointer}
.gcs-part span{display:block}
.gcs-part .lbl{font-size:12px;color:var(--muted)}
.gcs-part .val{font-size:22px;font-weight:600;color:var(--brand)}
.gcs-sum{
  background:var(--brand);color:#fff;
  border-radius:20px;padding:6px 16px;
  font-size:16px;font-weight:600;
  align-self:center;
}

.dial-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1000;display:none;
  align-items:flex-end;justify-content:center;
  touch-action:none;
  overscroll-behavior:contain;
}
.dial-overlay.show{display:flex}
body.dial-open{overflow:hidden;position:fixed;width:100%;}
.dial-container{
  background:#fff;
  border-radius:16px 16px 0 0;
  width:100%;max-width:500px;
  padding-bottom:var(--safe-bottom);
  animation:slideUp 0.25s ease-out;
}
@keyframes slideUp{from{transform:translateY(100%)}}
.dial-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 20px;border-bottom:0.5px solid var(--line);
}
.dial-title{font-size:17px;font-weight:600}
.dial-done{
  background:none;border:none;
  color:var(--brand);font-size:17px;font-weight:600;
}
.dial-body{
  display:flex;justify-content:center;
  padding:20px;gap:10px;
}
.dial-wheel{
  height:200px;width:120px;
  overflow:hidden;position:relative;
  touch-action:pan-y;
}
.dial-wheel::before,.dial-wheel::after{
  content:'';position:absolute;left:0;right:0;
  height:80px;pointer-events:none;z-index:2;
}
.dial-wheel::before{
  top:0;
  background:linear-gradient(to bottom,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-wheel::after{
  bottom:0;
  background:linear-gradient(to top,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-highlight{
  position:absolute;top:50%;left:0;right:0;
  height:40px;transform:translateY(-50%);
  background:var(--chip);border-radius:8px;
  z-index:1;
}
.dial-scroll{
  position:relative;z-index:3;
  padding:80px 0;
  transition:transform 0.15s ease-out;
}
.dial-option{
  height:40px;display:flex;
  align-items:center;justify-content:center;
  font-size:18px;font-weight:500;
  color:#999;
  transition:all 0.15s;
}
.dial-option.selected{
  color:var(--ink);font-weight:600;
  font-size:22px;
}
.dial-unit{
  font-size:14px;color:var(--muted);
  align-self:center;
}

.exam-tabs{
  display:flex;gap:8px;overflow-x:auto;
  padding:0 0 10px;margin:0 -16px;padding-left:16px;
  -webkit-overflow-scrolling:touch;
}
.exam-tabs::-webkit-scrollbar{display:none}
.exam-tab{
  flex-shrink:0;
  padding:10px 16px;border-radius:20px;
  background:var(--chip);font-size:14px;font-weight:500;
  cursor:pointer;
}
.exam-tab.active{background:var(--brand);color:#fff}
.exam-pane{display:none}
.exam-pane.active{display:block}
.memo{
  margin-top:8px;background:var(--chip);
  border-radius:10px;padding:12px;
  font-size:14px;min-height:60px;
}

.result{
  white-space:pre-wrap;
  background:#fafafa;border-radius:12px;
  padding:14px;font-size:13px;line-height:1.7;
  min-height:300px;
  border:1px dashed var(--line);
}

.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(255,255,255,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:0.5px solid var(--line);
  padding:10px 16px calc(10px + var(--safe-bottom));
  display:flex;gap:10px;z-index:100;
}
.bottom-nav .btn{flex:1;padding:12px}

.hospital-item{
  display:flex;justify-content:space-between;
  align-items:center;padding:12px 0;
  border-bottom:0.5px solid var(--line);
}
.hospital-item:last-child{border-bottom:none}

.checkline{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.checkline label{
  display:flex;align-items:center;gap:6px;
  font-size:14px;margin:0;
}
.checkline input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--brand);
}

.labline{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.labpill{
  display:flex;align-items:center;gap:6px;
  background:var(--chip);border-radius:20px;
  padding:8px 12px;
}
.labpill label{margin:0;font-size:13px;font-weight:500}
.labpill input{
  width:70px;padding:6px 8px;
  background:#fff;border:1px solid var(--line);
  border-radius:6px;font-size:14px;
}
.labpill .unit{font-size:12px;color:var(--muted)}
.labpill button{
  background:none;border:none;
  font-size:16px;color:#dc2626;padding:0 4px;
}

.problem-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:var(--chip);
  border-radius:10px;
  margin-bottom:8px;
}
.problem-item span{
  font-size:14px;
  flex:1;
  min-width:0;
}
.problem-item .del-btn{
  margin-left:12px;
  flex-shrink:0;
  padding:6px 12px;
  font-size:13px;
  background:none;
  border:1px solid #dc2626;
  color:#dc2626;
  border-radius:6px;
}

.nihss-btn{
  min-width:36px;height:36px;
  border:1px solid var(--line);border-radius:8px;
  background:#fff;font-size:15px;font-weight:500;
  cursor:pointer;
}
.nihss-btn.active{
  background:var(--brand);color:#fff;border-color:var(--brand);
}
</style>
</head>
<body>
<header>
  <h1>ğŸš ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªæ´»å‹•è¨˜éŒ²</h1>
  <p class="sub">heli record v3.5</p>
</header>

<main>
  <div class="card">
    <div class="card-header">ğŸ“ è¦è«‹æƒ…å ±</div>
    <div class="card-body">
      <label>è¦è«‹æ–¹æ³•</label>
      <select id="request_type">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹</option>
        <option value="ç¾ç€å¾Œè¦è«‹">ç¾ç€å¾Œè¦è«‹</option>
        <option value="æ–½è¨­é–“æ¬é€">æ–½è¨­é–“æ¬é€</option>
        <option value="ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼">ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼</option>
      </select>
      <label>è¦è«‹å†…å®¹</label>
      <textarea id="request_detail" placeholder="è¦è«‹ã®è©³ç´°å†…å®¹ã‚’è¨˜è¼‰"></textarea>
      
      <h3>æ‚£è€…æƒ…å ±</h3>
      <label>æ—¢å¾€æ­´</label>
      <textarea id="patient_history" placeholder="æ—¢å¾€æ­´ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>å¸¸ç”¨è–¬</label>
      <textarea id="patient_medication" placeholder="å¸¸ç”¨è–¬ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
      <textarea id="patient_allergy" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>æœ€çµ‚é£Ÿäº‹æ™‚åˆ»</label>
      <div class="time-row">
        <input type="time" id="last_meal_time">
        <button class="time-btn" onclick="setNow('last_meal_time')">Now</button>
      </div>
      <label>ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢</label>
      <textarea id="patient_hospital" placeholder="ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="card-body">
      <div class="grid2">
        <div><label>è¦è«‹</label><div class="time-row"><input type="time" id="request_time"><button class="time-btn" onclick="setNow('request_time')">Now</button></div></div>
        <div><label>ãƒ˜ãƒªé›¢é™¸</label><div class="time-row"><input type="time" id="heli_takeoff"><button class="time-btn" onclick="setNow('heli_takeoff')">Now</button></div></div>
        <div><label>LZç€é™¸</label><div class="time-row"><input type="time" id="heli_lz_landing"><button class="time-btn" onclick="setNow('heli_lz_landing')">Now</button></div></div>
        <div><label>FDæ¥è§¦</label><div class="time-row"><input type="time" id="fd_contact"><button class="time-btn" onclick="setNow('fd_contact')">Now</button></div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ</div>
    <div class="card-body">
      <div class="grid2">
        <div><label>è¦šçŸ¥</label><div class="time-row"><input type="time" id="ems_aware"><button class="time-btn" onclick="setNow('ems_aware')">Now</button></div></div>
        <div><label>ç¾ç€</label><div class="time-row"><input type="time" id="ems_arrival"><button class="time-btn" onclick="setNow('ems_arrival')">Now</button></div></div>
        <div><label>æ¥è§¦</label><div class="time-row"><input type="time" id="ems_contact"><button class="time-btn" onclick="setNow('ems_contact')">Now</button></div></div>
        <div><label>LZç€</label><div class="time-row"><input type="time" id="ems_lz"><button class="time-btn" onclick="setNow('ems_lz')">Now</button></div></div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addEmsVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="ems_vitals_container"></div>

      <h3>æ¥è§¦æ™‚æ‰€è¦‹</h3>
      <div class="exam-tabs" id="ems_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3><div class="chips" id="ems-gen-head"></div><textarea class="memo" id="memo-ems-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3><div class="chips" id="ems-gen-resp"></div><textarea class="memo" id="memo-ems-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3><div class="chips" id="ems-gen-card"></div><textarea class="memo" id="memo-ems-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3><div class="chips" id="ems-gen-abd"></div><textarea class="memo" id="memo-ems-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3><div class="chips" id="ems-gen-limb"></div><textarea class="memo" id="memo-ems-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3><div class="chips" id="ems-gen-neuro"></div><textarea class="memo" id="memo-ems-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3><div class="chips" id="ems-tra-head"></div><textarea class="memo" id="memo-ems-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3><div class="chips" id="ems-tra-neck"></div><textarea class="memo" id="memo-ems-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3><div class="chips" id="ems-tra-chest"></div><textarea class="memo" id="memo-ems-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3><div class="chips" id="ems-tra-abd"></div><textarea class="memo" id="memo-ems-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3><div class="chips" id="ems-tra-pelvis"></div><textarea class="memo" id="memo-ems-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3><div class="chips" id="ems-tra-limb"></div><textarea class="memo" id="memo-ems-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>æ„è­˜</h3><div class="chips" id="ems-str-conscious"></div>
        <h3>é¡”é¢ãƒ»ç™ºèª</h3><div class="chips" id="ems-str-face"></div>
        <h3>é‹å‹•</h3><div class="chips" id="ems-str-motor"></div>
        <h3>ãã®ä»–ç—‡çŠ¶</h3><div class="chips" id="ems-str-other"></div>
        <label style="margin-top:12px">ç™ºç—‡æ™‚åˆ»</label>
        <div class="time-row"><input type="time" id="ems_stroke_onset"><button class="time-btn" onclick="setNow('ems_stroke_onset')">Now</button></div>
        <textarea class="memo" id="memo-ems-str" placeholder="è„³å’ä¸­æ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>åˆæœŸæ³¢å½¢</h3><div class="chips" id="ems-cpa-rhythm"></div>
        <h3>ç›®æ’ƒ</h3><div class="chips" id="ems-cpa-witness"></div>
        <h3>æ°—é“</h3><div class="chips" id="ems-cpa-airway"></div>
        <h3>å¾ªç’°</h3><div class="chips" id="ems-cpa-circulation"></div>
        <h3>èƒ¸è…¹éƒ¨</h3><div class="chips" id="ems-cpa-chest"></div>
        <textarea class="memo" id="memo-ems-cpa" placeholder="CPAæ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="ems_procedures"></div>
      <div id="ems_o2_amount" style="display:none;margin-top:8px">
        <label>é…¸ç´ æŠ•ä¸é‡</label>
        <select id="ems_o2_flow">
          <option value="">é¸æŠ</option><option value="1L/min">1L/min</option><option value="2L/min">2L/min</option><option value="3L/min">3L/min</option><option value="5L/min">5L/min</option><option value="6L/min">6L/min</option><option value="10L/min">10L/min</option><option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼10L">ãƒªã‚¶ãƒ¼ãƒãƒ¼10L</option><option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼15L">ãƒªã‚¶ãƒ¼ãƒãƒ¼15L</option>
        </select>
      </div>
      <textarea id="ems_procedures_detail" placeholder="ãã®ä»–ã®å‡¦ç½®"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸ‘¨â€âš•ï¸ ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼</div>
    <div class="card-body">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addFdVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="fd_vitals_container"></div>

      <h3 style="margin-top:16px">èº«ä½“æ‰€è¦‹</h3>
      <div class="exam-tabs" id="fd_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3><div class="chips" id="fd-gen-head"></div><textarea class="memo" id="memo-fd-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3><div class="chips" id="fd-gen-resp"></div><textarea class="memo" id="memo-fd-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3><div class="chips" id="fd-gen-card"></div><textarea class="memo" id="memo-fd-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3><div class="chips" id="fd-gen-abd"></div><textarea class="memo" id="memo-fd-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3><div class="chips" id="fd-gen-limb"></div><textarea class="memo" id="memo-fd-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3><div class="chips" id="fd-gen-neuro"></div><textarea class="memo" id="memo-fd-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨</h3><div class="chips" id="fd-tra-head"></div><textarea class="memo" id="memo-fd-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3><div class="chips" id="fd-tra-neck"></div><textarea class="memo" id="memo-fd-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3><div class="chips" id="fd-tra-chest"></div><textarea class="memo" id="memo-fd-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3><div class="chips" id="fd-tra-abd"></div><textarea class="memo" id="memo-fd-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3><div class="chips" id="fd-tra-pelvis"></div><textarea class="memo" id="memo-fd-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3><div class="chips" id="fd-tra-limb"></div><textarea class="memo" id="memo-fd-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>ç³å­”ãƒ»çœ¼çƒ</h3>
        <div class="grid2">
          <div><label>ç³å­”å¾„ å·¦(mm)</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openPupilDial('L')"><span class="vital-value" id="pupilL_display">3</span></div></div>
          <div><label>ç³å­”å¾„ å³(mm)</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center" onclick="openPupilDial('R')"><span class="vital-value" id="pupilR_display">3</span></div></div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div><label>å¯¾å…‰ å·¦</label><select id="plrL"><option value="">--</option><option value="è¿…é€Ÿ">è¿…é€Ÿ</option><option value="é…å»¶">é…å»¶</option><option value="æ¶ˆå¤±">æ¶ˆå¤±</option></select></div>
          <div><label>å¯¾å…‰ å³</label><select id="plrR"><option value="">--</option><option value="è¿…é€Ÿ">è¿…é€Ÿ</option><option value="é…å»¶">é…å»¶</option><option value="æ¶ˆå¤±">æ¶ˆå¤±</option></select></div>
        </div>
        <h3>é‹å‹•(MMT)</h3>
        <div class="grid2">
          <div onclick="openMmtDial('ru')"><label>å³ä¸Šè‚¢</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center"><span class="vital-value" id="mmt_ru_display">5</span></div></div>
          <div onclick="openMmtDial('lu')"><label>å·¦ä¸Šè‚¢</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center"><span class="vital-value" id="mmt_lu_display">5</span></div></div>
          <div onclick="openMmtDial('rl')"><label>å³ä¸‹è‚¢</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center"><span class="vital-value" id="mmt_rl_display">5</span></div></div>
          <div onclick="openMmtDial('ll')"><label>å·¦ä¸‹è‚¢</label><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center"><span class="vital-value" id="mmt_ll_display">5</span></div></div>
        </div>
        <details style="margin-top:12px;background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)">
          <summary style="font-weight:600;cursor:pointer">NIHSS <span id="nihss_sum" style="margin-left:8px;background:var(--brand);color:#fff;padding:2px 10px;border-radius:12px;font-size:13px">0ç‚¹</span></summary>
          <div style="margin-top:12px" id="nihss_area"></div><textarea class="memo" id="nihss_memo" placeholder="NIHSSãƒ¡ãƒ¢"></textarea>
        </details>
      </div>

      <div class="exam-pane" data-pane="cpa"><div id="cpa_events_container"></div><button class="btn small" style="margin-top:12px" onclick="addCpaEvent()">ï¼‹ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ </button></div>

      <h3>æ¤œæŸ»</h3>
      <div class="checkline"><label><input type="checkbox" id="exam_bs" onchange="toggleExam('bs')"> è¡€ç³–</label><label><input type="checkbox" id="exam_us" onchange="toggleExam('us')"> US</label><label><input type="checkbox" id="exam_ecg" onchange="toggleExam('ecg')"> 12èª˜å°</label><label><input type="checkbox" id="exam_fast" onchange="toggleExam('fast')"> FAST</label><label><input type="checkbox" id="exam_efast" onchange="toggleExam('efast')"> eFAST</label></div>
      <div id="exam_bs_area" style="display:none;margin-top:8px"><div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:12px;cursor:pointer;display:inline-block" onclick="openBsDial()"><div class="vital-value" id="fd_bs_display">120</div><div class="vital-unit">mg/dL</div></div></div>
      <textarea id="exam_us_txt" placeholder="è¶…éŸ³æ³¢æ‰€è¦‹" style="display:none;margin-top:8px"></textarea><textarea id="exam_ecg_txt" placeholder="12èª˜å°æ‰€è¦‹" style="display:none;margin-top:8px"></textarea><textarea id="exam_fast_txt" placeholder="FASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea><textarea id="exam_efast_txt" placeholder="eFASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      
      <div class="grid2" style="margin-top:8px"><div><label>è¡€ã‚¬ã‚¹</label><select id="fd_abg_type" onchange="toggleAbg()"><option value="">æœªå®Ÿæ–½</option><option value="ABG">ABG</option><option value="VBG">VBG</option></select></div></div>
      <div id="abg_area" style="display:none;margin-top:10px"><div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn small" onclick="addAbgSet()">ã‚»ãƒƒãƒˆè¿½åŠ </button><button class="btn small ghost" onclick="clearAbg()">ã‚¯ãƒªã‚¢</button></div><div id="abg_pills" class="labline"></div></div>
      
      <h3>å‡¦ç½®ãƒ»è–¬å‰¤</h3>
      <div class="chips" id="fd_procedures"></div><textarea id="fd_procedure_detail" placeholder="å‡¦ç½®è©³ç´°"></textarea>
      <div class="chips" id="fd_drugs"></div><textarea id="fd_drug_detail" placeholder="è–¬å‰¤è©³ç´°"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="card-header">ğŸ“‹ è©•ä¾¡ãƒ»æ¬é€</div>
    <div class="card-body">
      <h3>ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ </h3><div style="display:flex;gap:8px;margin-bottom:10px"><input type="text" id="new_problem" placeholder="å…¥åŠ›" style="flex:1"><button class="btn small" onclick="addProblem()">ï¼‹</button></div><div id="problems"></div>
      <label>è€ƒå¯Ÿ</label><textarea id="consideration" placeholder="è€ƒå¯Ÿ"></textarea>
      <label>åŒ»ç™‚æ©Ÿé–¢</label><div class="chips" id="destination_chips"></div><input type="text" id="destination_custom" placeholder="è‡ªç”±å…¥åŠ›">
      <label>æ´»å‹•</label><select id="turn_type"><option value="Iã‚¿ãƒ¼ãƒ³">Iã‚¿ãƒ¼ãƒ³</option><option value="Jã‚¿ãƒ¼ãƒ³">Jã‚¿ãƒ¼ãƒ³</option><option value="Uã‚¿ãƒ¼ãƒ³">Uã‚¿ãƒ¼ãƒ³</option></select>
    </div>
  </div>

  <div class="card"><div class="card-header">ğŸ“„ æ´»å‹•è¨˜éŒ²</div><div class="card-body"><div class="result" id="outText"></div></div></div>
</main>

<div class="bottom-nav"><button class="btn" id="copyOut">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button><button class="btn ghost" onclick="saveData()">ğŸ’¾ ä¿å­˜</button><button class="btn ghost" onclick="loadData()">ğŸ“‚ èª­è¾¼</button><button class="btn ghost" onclick="resetData()" style="color:#dc2626">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button></div>

<div class="dial-overlay" id="dialOverlay" onclick="closeDial(event)"><div class="dial-container" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()"><div class="dial-header"><span class="dial-title" id="dialTitle">é¸æŠ</span><button class="dial-done" onclick="confirmDial()">å®Œäº†</button></div><div class="dial-body" id="dialBody"></div></div></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// å„ç¨®å®šç¾©
const EMS_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”è‰²è‰¯å¥½'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','å†·æ±—','ç™ºç†±']},
  resp: {normal:['å‘¼å¸å®‰å®š','å‘¼å¸è‹¦ãªã—'], abn:['å‘¼å¸å›°é›£','åŠªåŠ›å‘¼å¸','é »å‘¼å¸','èµ·åå‘¼å¸','é™¥æ²¡å‘¼å¸']},
  card: {normal:['è„ˆæ‹æ•´','æœ«æ¢¢æ¸©ã‹ã„'], abn:['è„ˆæ‹ä¸æ•´','é »è„ˆ','å¾è„ˆ','æœ«æ¢¢å†·æ„Ÿ','å†·æ±—']},
  abd: {normal:['è…¹éƒ¨å¹³å¦','åœ§ç—›ãªã—'], abn:['è…¹éƒ¨è†¨æº€','åœ§ç—›','ç­‹æ€§é˜²å¾¡','å˜”å']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','ä¸‹è…¿æµ®è…«','å¤‰å½¢']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”å·¦å³å·®']}
};
const EMS_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²','é¡”é¢æ‰“æ’²','é¼»å‡ºè¡€','å£è…”å†…å‡ºè¡€']},
  neck: {normal:['å¾Œé ¸éƒ¨åœ§ç—›ãªã—'], abn:['é ¸éƒ¨æ‰“æ’²','å¾Œé ¸éƒ¨åœ§ç—›','é ¸é™è„ˆæ€’å¼µ']},
  chest: {normal:['å‘¼å¸éŸ³æ¸…'], abn:['èƒ¸å£æ‰“æ’²','èƒ¸å£åœ§ç—›','å‹•æºèƒ¸éƒ­','å‘¼å¸éŸ³æ¸›å¼±']},
  abd: {normal:[], abn:['è…¹éƒ¨åœ§ç—›','è…¹éƒ¨è†¨æº€','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—'], abn:['éª¨ç›¤åœ§ç—›','éª¨ç›¤å‹•æº','ä¼šé™°éƒ¨å‡ºè¡€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè‰¯å¥½'], abn:['å››è‚¢æ‰“æ’²','å››è‚¢å¤‰å½¢','é–‹æ”¾å‰µ','æœ«æ¢¢å†·æ„Ÿ']}
};
const EMS_STR_GROUPS = {
  conscious: {normal:['æ„è­˜æ¸…æ˜'], abn:['æ„è­˜éšœå®³','JCS 1æ¡','JCS 2æ¡','JCS 3æ¡']},
  face: {normal:['é¡”é¢éº»ç—ºãªã—','æ§‹éŸ³éšœå®³ãªã—'], abn:['é¡”é¢éº»ç—º','æ§‹éŸ³éšœå®³','å‘‚å¾‹éšœå®³']},
  motor: {normal:['ä¿æŒå¯'], abn:['ä¸Šè‚¢æŒ™ä¸Šä¸å¯(å³)','ä¸Šè‚¢æŒ™ä¸Šä¸å¯(left)','ç‰‡éº»ç—º(å³)','ç‰‡éº»ç—º(left)']},
  other: {normal:[], abn:['ç³å­”ä¸åŒ','å…±åŒåè¦–','é ­ç—›','å˜”å','ã‚ã¾ã„','ç—™æ”£','å¤±èª']}
};
const EMS_CPA_GROUPS = {
  rhythm: {normal:[], abn:['Vf','Pulseless VT','PEA','Asystole']},
  witness: {normal:['ç›®æ’ƒã‚ã‚Š','BP-CPRã‚ã‚Š'], abn:['ç›®æ’ƒãªã—','BP-CPRãªã—']},
  airway: {normal:['é–‹é€šè‰¯å¥½'], abn:['æ°—é“é–‰å¡','åç‰©','å‡ºè¡€']},
  circulation: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  chest: {normal:['èƒ¸éƒ­æŒ™ä¸Šè‰¯å¥½'], abn:['èƒ¸éƒ­æŒ™ä¸Šä¸è‰¯','å‘¼å¸éŸ³æ¸›å¼±','è…¹éƒ¨è†¨éš†']}
};
const FD_GEN_GROUPS = EMS_GEN_GROUPS;
const FD_TRA_GROUPS = EMS_TRA_GROUPS;

let state = {
  request: {type:'', detail:'', time:''},
  patient: {history:'', medication:'', allergy:'', lastMeal:'', hospital:''},
  heli: {takeoff:'', lz_landing:'', fd_contact:'', turn_type:'Iã‚¿ãƒ¼ãƒ³', transport_takeoff:'', hospital_arrival:''},
  ems: { aware:'', arrival:'', contact:'', lz:'', vitals: [], exam_tab: 'general', chips: {}, memos: {general:{},trauma:{},stroke:{},cpa:{}}, procedures: {}, procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'], o2_flow:'' },
  fd: { vitals: [], exam_tab: 'general', chips: {}, memos: {general:{},trauma:{},stroke:{},cpa:{}}, exams: {bs:false, us:false, ecg:false, fast:false, efast:false}, exam_texts: {us:'', ecg:'', fast:'', efast:''}, bs:120, abg_type:'', abg_data: [], cpaEvents: [], stroke: { pupilL:3, pupilR:3, plrL:'', plrR:'', mmt:{ru:5, lu:5, rl:5, ll:5}, nihss:{} }, procedures: {}, procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','CPR','é™¤ç´°å‹•'], drugs: {}, drugs_items: ['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹'] },
  problems: [], consideration: '', destination: {hospital:'', custom:'', reason:''},
  hospitals: {'é¹¿å…å³¶': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œ','ä»Šæ‘ç·åˆ','ä¸­å¤®ç—…é™¢','åšåœ°è„³å¤–'],'å—è–©': ['æŒ‡å®¿åŒ»ç™‚','è–©å—ç—…é™¢','æ•å´å¸‚ç«‹'],'å·è–©': ['æ¸ˆç”Ÿä¼šå·å†…','å·å†…å¸‚æ°‘'],'éœ§å³¶': ['éœ§å³¶åŒ»å¸«ä¼š','éœ§å³¶è¨˜å¿µ'],'è‚å±': ['é¹¿å±‹åŒ»ç™‚','å¤§éš…é¹¿å±‹']}
};

// å…±é€šãƒ­ã‚¸ãƒƒã‚¯
const $S = s => JSON.stringify(s); const $P = s => JSON.parse(s);
let dialCallback = null; let dialWheels = []; let scrollPosition = 0;

function openDial(title, wheels, callback) {
  scrollPosition = window.pageYOffset; document.body.classList.add('dial-open'); document.body.style.top = `-${scrollPosition}px`;
  dialCallback = callback; dialWheels = wheels; $('#dialTitle').textContent = title;
  const body = $('#dialBody'); body.innerHTML = '';
  wheels.forEach((w, wi) => {
    const wheel = document.createElement('div'); wheel.className = 'dial-wheel'; wheel.innerHTML = '<div class="dial-highlight"></div>';
    const scroll = document.createElement('div'); scroll.className = 'dial-scroll'; scroll.dataset.wheelIndex = wi;
    w.options.forEach((opt, oi) => {
      const div = document.createElement('div'); div.className = 'dial-option'; div.textContent = opt.label;
      if(opt.value == w.selected) div.classList.add('selected'); scroll.appendChild(div);
    });
    wheel.appendChild(scroll); body.appendChild(wheel);
    if(w.unit) { const unit = document.createElement('div'); unit.className = 'dial-unit'; unit.textContent = w.unit; body.appendChild(unit); }
    let curIdx = w.options.findIndex(o => o.value == w.selected); if(curIdx < 0) curIdx = 0;
    let offset = -curIdx * 40; let startY = 0;
    scroll.style.transform = `translateY(${offset}px)`;
    scroll.addEventListener('touchstart', e => { e.preventDefault(); startY = e.touches[0].clientY; }, {passive: false});
    scroll.addEventListener('touchmove', e => {
      e.preventDefault(); const dy = e.touches[0].clientY - startY; offset += dy;
      scroll.style.transform = `translateY(${offset}px)`; startY = e.touches[0].clientY;
    }, {passive: false});
    scroll.addEventListener('touchend', e => {
      e.preventDefault(); let idx = Math.round(-offset/40); idx = Math.max(0, Math.min(w.options.length-1, idx));
      offset = -idx*40; w.selected = w.options[idx].value;
      scroll.style.transition = 'transform 0.2s'; scroll.style.transform = `translateY(${offset}px)`;
      scroll.querySelectorAll('.dial-option').forEach((o, i) => o.classList.toggle('selected', i === idx));
    }, {passive: false});
  });
  $('#dialOverlay').classList.add('show');
}
function closeDial() { $('#dialOverlay').classList.remove('show'); document.body.classList.remove('dial-open'); document.body.style.top = ''; window.scrollTo(0, scrollPosition); }
function confirmDial() { if(dialCallback) dialCallback(dialWheels.map(w => w.selected)); closeDial(); }

function genRange(f, t, s) { let a = []; for(let i=f; i<=t; i+=s) a.push({label: String(i), value: i}); return a; }
function openVitalDial(type, idx, field) {
  const v = state[type].vitals[idx]; let wheels = [], title = '';
  switch(field) {
    case 'bp': title = 'è¡€åœ§'; wheels = [{options: genRange(0, 250, 1), selected: v.sbp, unit: '/'},{options: genRange(0, 150, 1), selected: v.dbp, unit: 'mmHg'}]; break;
    case 'hr': title = 'å¿ƒæ‹æ•°'; wheels = [{options: genRange(0, 250, 1), selected: v.hr, unit: 'bpm'}]; break;
    case 'rr': title = 'å‘¼å¸æ•°'; wheels = [{options: genRange(0, 45, 1), selected: v.rr, unit: '/min'}]; break;
    case 'spo2': title = 'SpO2'; wheels = [{options: genRange(40, 100, 1), selected: v.spo2, unit: '%'}]; break;
    case 'bt': title = 'ä½“æ¸©'; wheels = [{options: genRange(32, 42, 0.1).map(x=>({label:x.toFixed(1),value:parseFloat(x.toFixed(1))})), selected: v.bt, unit: 'C'}]; break;
    case 'jcs': title = 'JCS'; wheels = [{options: ['0','1','2','3','10','20','30','100','200','300'].map(x=>({label:x,value:x})), selected: v.jcs}]; break;
  }
  openDial(title, wheels, vals => {
    if(field==='bp'){v.sbp=vals[0];v.dbp=vals[1]} else if(field==='hr')v.hr=vals[0]; else if(field==='rr')v.rr=vals[0]; else if(field==='spo2')v.spo2=vals[0]; else if(field==='bt')v.bt=vals[0]; else if(field==='jcs')v.jcs=vals[0];
    type==='ems'?renderEmsVitals():renderFdVitals(); updateState();
  });
}

function addEmsVital() { const n=new Date(); const t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; state.ems.vitals.push({time:t,sbp:120,dbp:80,hr:80,rr:16,spo2:98,bt:36.5,gcs:{e:4,v:5,m:6},jcs:'0'}); renderEmsVitals(); updateState(); }
function addFdVital() { const n=new Date(); const t=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; state.fd.vitals.push({time:t,sbp:120,dbp:80,hr:80,rr:16,spo2:98,bt:36.5,gcs:{e:4,v:5,m:6},jcs:'0'}); renderFdVitals(); updateState(); }
function removeVital(t,i) { if(confirm('å‰Šé™¤?')){ state[t].vitals.splice(i,1); t==='ems'?renderEmsVitals():renderFdVitals(); updateState(); } }
function renderEmsVitals() { const c=$('#ems_vitals_container'); c.innerHTML=''; state.ems.vitals.forEach((v,i)=>c.appendChild(createVitalCard('ems',i,v))); }
function renderFdVitals() { const c=$('#fd_vitals_container'); c.innerHTML=''; state.fd.vitals.forEach((v,i)=>c.appendChild(createVitalCard('fd',i,v))); }
function createVitalCard(t,idx,v) {
  const c = document.createElement('div'); c.className='vital-card';
  c.innerHTML = `<div class="vital-header"><input type="time" value="${v.time}" onchange="state.${t}.vitals[${idx}].time=this.value;updateState()"><button class="vital-del" onclick="removeVital('${t}',${idx})">å‰Šé™¤</button></div>
    <div class="vital-grid">
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'bp')"><div class="vital-label">BP</div><div class="vital-value">${v.sbp}/${v.dbp}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'hr')"><div class="vital-label">HR</div><div class="vital-value">${v.hr}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'rr')"><div class="vital-label">RR</div><div class="vital-value">${v.rr}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'spo2')"><div class="vital-label">SpO2</div><div class="vital-value">${v.spo2||'--'}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'bt')"><div class="vital-label">BT</div><div class="vital-value">${v.bt}</div></div>
      <div class="vital-item" onclick="openVitalDial('${t}',${idx},'jcs')"><div class="vital-label">JCS</div><div class="vital-value">${v.jcs}</div></div>
    </div>`; return c;
}

function setNow(id) { const n=new Date(); $(`#${id}`).value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; updateState(); }
function mkChip(l,m,p) {
  const e=document.createElement('span'); e.className='chip'; e.textContent=l; e.dataset.state=state[p].chips[l]||'';
  e.onclick=()=>{ let c=e.dataset.state,n=''; if(m==='normal')n=(c==='on'?'':'on'); else n=(c===''?'+':c==='+'?'-':''); e.dataset.state=n; if(n)state[p].chips[l]=n; else delete state[p].chips[l]; updateState(); }; return e;
}
function mountChips(id,def,p) { const b=$(id); if(!b) return; b.innerHTML=''; (def.normal||[]).forEach(x=>b.appendChild(mkChip(x,'normal',p))); (def.abn||[]).forEach(x=>b.appendChild(mkChip(x,'abn',p))); }
function renderProcedureChips(id,its,obj) {
  const c=$(id); c.innerHTML=''; its.forEach(it=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.textContent=it; if(obj[it]) chip.dataset.state='proc';
    chip.onclick=()=>{ obj[it]=!obj[it]; chip.dataset.state=obj[it]?'proc':''; if(id==='ems_procedures'&&it==='é…¸ç´ æŠ•ä¸')$('#ems_o2_amount').style.display=obj[it]?'block':'none'; updateState(); }; c.appendChild(chip);
  });
}
function setupExamTabs(p) {
  $$(`#${p}_examTabs .exam-tab`).forEach(tab=>{
    tab.onclick=()=>{ $$(`#${p}_examTabs .exam-tab`).forEach(t=>t.classList.remove('active')); tab.classList.add('active'); state[p].exam_tab=tab.dataset.exam; const card=tab.closest('.card'); card.querySelectorAll('.exam-pane').forEach(pn=>pn.classList.remove('active')); card.querySelector(`.exam-pane[data-pane="${tab.dataset.exam}"]`).classList.add('active'); updateState(); };
  });
}

function updateState() {
  state.request.type=$('#request_type').value; state.request.detail=$('#request_detail').value; state.request.time=$('#request_time').value;
  state.heli={...state.heli, takeoff:$('#heli_takeoff').value, lz_landing:$('#heli_lz_landing').value, fd_contact:$('#fd_contact').value, turn_type:$('#turn_type').value};
  state.destination.custom=$('#destination_custom').value; state.consideration=$('#consideration').value;
  render(); localStorage.setItem('heliRecordV35', $S(state));
}

function render() { $('#outText').textContent = generateReport(); }
function fmtFinding(l, s) { if(s==='on')return l; if(s==='+')return `${l}(+)`; if(s==='-')return `${l}(-)`; return null; }
function extractFindings(d, c) { let a=[]; (Array.isArray(d)?d:(d.normal||[]).concat(d.abn||[])).forEach(l=>{ if(c[l]){let s=fmtFinding(l,c[l]);if(s)a.push(s);} }); return a.join('ã€'); }

function generateReport() {
  let r = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ç—…é™¢å‰åŒ»ç™‚æ´»å‹•è¨˜éŒ² v3.5\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nã€è¦è«‹ã€‘'+(state.request.type||'')+' '+(state.request.time||'')+'\n'+(state.request.detail||'')+'\n';
  r+='\nã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€‘\nãƒ˜ãƒªé›¢é™¸ï¼š'+state.heli.takeoff+'\nLZç€ï¼š'+state.heli.lz_landing+'\nFDæ¥è§¦ï¼š'+state.heli.fd_contact+'\næ´»å‹•ï¼š'+state.heli.turn_type+'\n';
  r+='\nã€æ•‘æ€¥éšŠã€‘\n'; e=state.ems; e.vitals.forEach(v=>{ r+=`[${v.time}] ${v.sbp}/${v.dbp}, HR${v.hr}, RR${v.rr}, SpO2 ${v.spo2||'--'}, JCS${v.jcs}\n`; });
  r+='æ‰€è¦‹ï¼š'+extractFindings(EMS_GEN_GROUPS.head,e.chips)+'\n';
  r+='\nã€ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼ã€‘\n'; f=state.fd; f.vitals.forEach(v=>{ r+=`[${v.time}] ${v.sbp}/${v.dbp}, HR${v.hr}, RR${v.rr}, SpO2 ${v.spo2||'--'}, JCS${v.jcs}\n`; });
  r+='è©•ä¾¡ï¼š'+state.problems.map((p,i)=>'#'+(i+1)+' '+p).join('\n')+'\næ¬é€ï¼š'+(state.destination.custom||state.destination.hospital)+'\n'; return r;
}

function saveData() { const b=new Blob([$S(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`heli_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
function loadData() { const i=document.createElement('input'); i.type='file'; i.onchange=e=>{ const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>{ state=$P(ev.target.result); restoreUI(); }; r.readAsText(f); } }; i.click(); }
function resetData() { if(confirm('ãƒªã‚»ãƒƒãƒˆ?')){ localStorage.removeItem('heliRecordV35'); location.reload(); } }

function restoreUI() {
  $('#request_type').value=state.request.type; $('#request_detail').value=state.request.detail; $('#request_time').value=state.request.time;
  $('#heli_takeoff').value=state.heli.takeoff; $('#heli_lz_landing').value=state.heli.lz_landing; $('#fd_contact').value=state.heli.fd_contact; $('#turn_type').value=state.heli.turn_type;
  $('#destination_custom').value=state.destination.custom; $('#consideration').value=state.consideration;
  renderEmsVitals(); renderFdVitals(); renderProcedureChips('ems_procedures', state.ems.procedures_items, state.ems.procedures); renderProcedureChips('fd_procedures', state.fd.procedures_items, state.fd.procedures); renderProcedureChips('fd_drugs', state.fd.drugs_items, state.fd.drugs); render();
}

function init() {
  const s = localStorage.getItem('heliRecordV35'); if(s) try{state=$P(s);}catch(e){}
  if(!state.ems.vitals.length) addEmsVital(); if(!state.fd.vitals.length) addFdVital();
  [['#ems-gen-head',EMS_GEN_GROUPS.head],['#ems-gen-resp',EMS_GEN_GROUPS.resp],['#ems-tra-head',EMS_TRA_GROUPS.head],['#ems-str-conscious',EMS_STR_GROUPS.conscious],['#ems-cpa-rhythm',EMS_CPA_GROUPS.rhythm]].forEach(x=>mountChips(x[0],x[1],'ems'));
  [['#fd-gen-head',FD_GEN_GROUPS.head],['#fd-tra-head',FD_TRA_GROUPS.head]].forEach(x=>mountChips(x[0],x[1],'fd'));
  setupExamTabs('ems'); setupExamTabs('fd'); restoreUI();
  $('#copyOut').onclick=()=>{ navigator.clipboard.writeText($('#outText').textContent); const b=$('#copyOut'); b.textContent='âœ“ å®Œäº†'; setTimeout(()=>b.textContent='ğŸ“‹ ã‚³ãƒ”ãƒ¼',1500); };
}
init();
</script>
</body>
</html>
