<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªåŒ»å¸«è¨˜éŒ² v3.3</title>
<style>
:root{
  --ink:#111827;--muted:#6b7280;--bg:#f2f2f7;--card:#fff;
  --line:#c6c6c8;--brand:#007aff;--chip:#f2f2f7;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;overscroll-behavior:none}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  color:var(--ink);background:var(--bg);
  padding-bottom:calc(60px + var(--safe-bottom));
}
header{
  position:sticky;top:0;z-index:100;
  background:rgba(242,242,247,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:0.5px solid var(--line);
  padding:calc(12px + var(--safe-top)) 16px 12px;
}
h1{margin:0;font-size:17px;font-weight:600;text-align:center}
.sub{margin:4px 0 0;color:var(--muted);font-size:12px;text-align:center}
main{padding:12px}
.card{
  background:#fff;border-radius:12px;
  margin-bottom:12px;overflow:hidden;
}
.card-header{
  padding:14px 16px 10px;
  font-size:15px;font-weight:600;
  border-bottom:0.5px solid var(--line);
}
.card-body{padding:12px 16px}
h3{margin:12px 0 8px;font-size:13px;color:var(--muted);font-weight:500}
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 4px}
input,textarea,select{
  width:100%;padding:12px;
  border:none;border-radius:10px;
  background:var(--chip);font-size:16px;
  -webkit-appearance:none;
}
textarea{resize:none;min-height:80px}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.time-row{display:flex;gap:8px;align-items:center}
.time-row input{flex:1}
.time-btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:8px;
  padding:12px 14px;font-size:14px;font-weight:500;
  white-space:nowrap;
}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.chip{
  background:var(--chip);border:1.5px solid transparent;
  border-radius:20px;padding:8px 14px;
  font-size:14px;font-weight:500;
  user-select:none;cursor:pointer;
  transition:all 0.15s;
}
.chip:active{transform:scale(0.95)}
.chip[data-state="on"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="+"]{background:#fee2e2;border-color:#f87171;color:#b91c1c}
.chip[data-state="-"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="proc"]{background:var(--brand);color:#fff}
.btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:10px;
  padding:14px 20px;font-size:15px;font-weight:600;
  width:100%;
}
.btn:active{opacity:0.8}
.btn.ghost{background:var(--chip);color:var(--ink)}
.btn.small{padding:10px 16px;font-size:14px}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-row .btn{flex:1}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆç›®æ’ƒã‚ã‚Š/ãªã—ç­‰ï¼‰ */
.toggle-btn{
  background:var(--chip);
  border:1.5px solid var(--line);
  border-radius:10px;
  padding:10px 16px;
  font-size:15px;font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
  user-select:none;
}
.toggle-btn:active{transform:scale(0.97)}
.toggle-btn.active{
  background:#dcfce7;
  border-color:#4ade80;
  color:#15803d;
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
@keyframes checkFlash {
  0% { background: transparent; }
  50% { background: rgba(0, 122, 255, 0.15); }
  100% { background: transparent; }
}
.check-flash {
  animation: checkFlash 0.4s ease-out;
  border-radius: 8px;
}

/* ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ - ãƒ€ã‚¤ãƒ¤ãƒ«å¼ */
.vital-card{
  background:#fff;border-radius:12px;
  margin-top:10px;overflow:hidden;
  border:1px solid var(--line);
}
.vital-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 14px;background:#f9fafb;
  border-bottom:0.5px solid var(--line);
}
.vital-time{
  display:flex;align-items:center;gap:8px;
}
.vital-time input{
  width:100px;padding:8px 10px;
  font-size:15px;font-weight:600;
  color:var(--brand);background:#fff;
  border:1px solid var(--line);border-radius:8px;
}
.vital-del{
  background:#fee2e2;color:#dc2626;
  border:none;border-radius:8px;
  padding:8px 12px;font-size:13px;font-weight:500;
}
.vital-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:1px;background:var(--line);
}
.vital-item{
  background:#fff;padding:10px 8px;
  text-align:center;cursor:pointer;
  transition:background 0.15s;
}
.vital-item:active{background:#f3f4f6}
.vital-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.vital-value{font-size:20px;font-weight:600;color:var(--ink)}
.vital-unit{font-size:11px;color:var(--muted)}
.vital-gcs{
  grid-column:span 3;
  display:flex;justify-content:center;gap:20px;
  padding:12px;
}
.gcs-part{text-align:center;cursor:pointer}
.gcs-part span{display:block}
.gcs-part .lbl{font-size:12px;color:var(--muted)}
.gcs-part .val{font-size:22px;font-weight:600;color:var(--brand)}
.gcs-sum{
  background:var(--brand);color:#fff;
  border-radius:20px;padding:6px 16px;
  font-size:16px;font-weight:600;
  align-self:center;
}

/* ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ */
.dial-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1000;display:none;
  align-items:flex-end;justify-content:center;
  touch-action:none;
  overscroll-behavior:contain;
}
.dial-overlay.show{display:flex}
body.dial-open{overflow:hidden;position:fixed;width:100%;}
.dial-container{
  background:#fff;
  border-radius:16px 16px 0 0;
  width:100%;max-width:500px;
  padding-bottom:var(--safe-bottom);
  animation:slideUp 0.25s ease-out;
}
@keyframes slideUp{from{transform:translateY(100%)}}
.dial-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 20px;border-bottom:0.5px solid var(--line);
}
.dial-title{font-size:17px;font-weight:600}
.dial-done{
  background:none;border:none;
  color:var(--brand);font-size:17px;font-weight:600;
}
.dial-body{
  display:flex;justify-content:center;
  padding:20px;gap:10px;
}
.dial-wheel{
  height:200px;width:120px;
  overflow:hidden;position:relative;
  touch-action:pan-y;
}
.dial-wheel::before,.dial-wheel::after{
  content:'';position:absolute;left:0;right:0;
  height:80px;pointer-events:none;z-index:2;
}
.dial-wheel::before{
  top:0;
  background:linear-gradient(to bottom,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-wheel::after{
  bottom:0;
  background:linear-gradient(to top,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-highlight{
  position:absolute;top:50%;left:0;right:0;
  height:40px;transform:translateY(-50%);
  background:var(--chip);border-radius:8px;
  z-index:1;
}
.dial-scroll{
  position:relative;z-index:3;
  padding:80px 0;
  transition:transform 0.15s ease-out;
}
.dial-option{
  height:40px;display:flex;
  align-items:center;justify-content:center;
  font-size:18px;font-weight:500;
  color:#999;
  transition:all 0.15s;
}
.dial-option.selected{
  color:var(--ink);font-weight:600;
  font-size:22px;
}
.dial-unit{
  font-size:14px;color:var(--muted);
  align-self:center;
}

/* æ‰€è¦‹ã‚¿ãƒ– */
.exam-tabs{
  display:flex;gap:8px;overflow-x:auto;
  padding:0 0 10px;margin:0 -16px;padding-left:16px;
  -webkit-overflow-scrolling:touch;
}
.exam-tabs::-webkit-scrollbar{display:none}
.exam-tab{
  flex-shrink:0;
  padding:10px 16px;border-radius:20px;
  background:var(--chip);font-size:14px;font-weight:500;
  cursor:pointer;
}
.exam-tab.active{background:var(--brand);color:#fff}
.exam-pane{display:none}
.exam-pane.active{display:block}
.memo{
  margin-top:8px;background:var(--chip);
  border-radius:10px;padding:12px;
  font-size:14px;min-height:60px;
}

/* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
.result{
  white-space:pre-wrap;
  background:#fafafa;border-radius:12px;
  padding:14px;font-size:13px;line-height:1.7;
  min-height:300px;
  border:1px dashed var(--line);
}

/* ä¸‹éƒ¨ãƒŠãƒ“ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(255,255,255,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:0.5px solid var(--line);
  padding:10px 16px calc(10px + var(--safe-bottom));
  display:flex;gap:10px;z-index:100;
}
.bottom-nav .btn{flex:1;padding:12px}

/* ç—…é™¢ãƒªã‚¹ãƒˆ */
.hospital-item{
  display:flex;justify-content:space-between;
  align-items:center;padding:12px 0;
  border-bottom:0.5px solid var(--line);
}
.hospital-item:last-child{border-bottom:none}

/* ãƒã‚§ãƒƒã‚¯ãƒ©ã‚¤ãƒ³ */
.checkline{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.checkline label{
  display:flex;align-items:center;gap:6px;
  font-size:14px;margin:0;
}
.checkline input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--brand);
}

/* ãƒ©ãƒœãƒ”ãƒ« */
.labline{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.labpill{
  display:flex;align-items:center;gap:6px;
  background:var(--chip);border-radius:20px;
  padding:8px 12px;
}
.labpill label{margin:0;font-size:13px;font-weight:500}
.labpill input{
  width:70px;padding:6px 8px;
  background:#fff;border:1px solid var(--line);
  border-radius:6px;font-size:14px;
}
.labpill .unit{font-size:12px;color:var(--muted)}
.labpill button{
  background:none;border:none;
  font-size:16px;color:#dc2626;padding:0 4px;
}

/* å•é¡Œãƒªã‚¹ãƒˆ */
.problem-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:var(--chip);
  border-radius:10px;
  margin-bottom:8px;
}
.problem-item span{
  font-size:14px;
  flex:1;
  min-width:0;
}
.problem-item .del-btn{
  margin-left:12px;
  flex-shrink:0;
  padding:6px 12px;
  font-size:13px;
  background:none;
  border:1px solid #dc2626;
  color:#dc2626;
  border-radius:6px;
}

/* NIHSSãƒœã‚¿ãƒ³ */
.nihss-btn{
  min-width:36px;height:36px;
  border:1px solid var(--line);border-radius:8px;
  background:#fff;font-size:15px;font-weight:500;
  cursor:pointer;
}
.nihss-btn.active{
  background:var(--brand);color:#fff;border-color:var(--brand);
}
</style>
</head>
<body>
<header>
  <h1>ğŸš ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ˜ãƒªåŒ»å¸«è¨˜éŒ²</h1>
  <p class="sub">heli record v3.3</p>
</header>

<main>
  <!-- è¦è«‹æƒ…å ± -->
  <div class="card">
    <div class="card-header">ğŸ“ è¦è«‹æƒ…å ±</div>
    <div class="card-body">
      <label>è¦è«‹æ–¹æ³•</label>
      <select id="request_type">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹</option>
        <option value="ç¾ç€å¾Œè¦è«‹">ç¾ç€å¾Œè¦è«‹</option>
        <option value="æ–½è¨­é–“æ¬é€">æ–½è¨­é–“æ¬é€</option>
        <option value="ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼">ãƒ‰ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒªãƒãƒªãƒ¼</option>
      </select>
      <label>è¦è«‹å†…å®¹</label>
      <textarea id="request_detail" placeholder="è¦è«‹ã®è©³ç´°å†…å®¹ã‚’è¨˜è¼‰"></textarea>
      
      <h3>æ‚£è€…æƒ…å ±</h3>
      <label>æ—¢å¾€æ­´</label>
      <textarea id="patient_history" placeholder="æ—¢å¾€æ­´ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>å¸¸ç”¨è–¬</label>
      <textarea id="patient_medication" placeholder="å¸¸ç”¨è–¬ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
      <textarea id="patient_allergy" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>æœ€çµ‚é£Ÿäº‹æ™‚åˆ»</label>
      <div class="time-row">
        <input type="time" id="last_meal_time">
        <button class="time-btn" onclick="setNow('last_meal_time')">Now</button>
      </div>
      <label>ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢</label>
      <textarea id="patient_hospital" placeholder="ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
    </div>
  </div>

  <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
  <div class="card">
    <div class="card-header">â±ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦è«‹</label>
          <div class="time-row">
            <input type="time" id="request_time">
            <button class="time-btn" onclick="setNow('request_time')">Now</button>
          </div>
        </div>
        <div>
          <label>ãƒ˜ãƒªé›¢é™¸</label>
          <div class="time-row">
            <input type="time" id="heli_takeoff">
            <button class="time-btn" onclick="setNow('heli_takeoff')">Now</button>
          </div>
        </div>
        <div>
          <label>LZç€é™¸</label>
          <div class="time-row">
            <input type="time" id="heli_lz_landing">
            <button class="time-btn" onclick="setNow('heli_lz_landing')">Now</button>
          </div>
        </div>
        <div>
          <label>FDæ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="fd_contact">
            <button class="time-btn" onclick="setNow('fd_contact')">Now</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ•‘æ€¥éšŠ -->
  <div class="card">
    <div class="card-header">ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦šçŸ¥</label>
          <div class="time-row">
            <input type="time" id="ems_aware">
            <button class="time-btn" onclick="setNow('ems_aware')">Now</button>
          </div>
        </div>
        <div>
          <label>ç¾ç€</label>
          <div class="time-row">
            <input type="time" id="ems_arrival">
            <button class="time-btn" onclick="setNow('ems_arrival')">Now</button>
          </div>
        </div>
        <div>
          <label>æ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="ems_contact">
            <button class="time-btn" onclick="setNow('ems_contact')">Now</button>
          </div>
        </div>
        <div>
          <label>LZç€</label>
          <div class="time-row">
            <input type="time" id="ems_lz">
            <button class="time-btn" onclick="setNow('ems_lz')">Now</button>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addEmsVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="ems_vitals_container"></div>

      <h3>æ¥è§¦æ™‚æ‰€è¦‹</h3>
      <div class="exam-tabs" id="ems_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="ems-gen-head"></div>
        <textarea class="memo" id="memo-ems-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="ems-gen-resp"></div>
        <textarea class="memo" id="memo-ems-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="ems-gen-card"></div>
        <textarea class="memo" id="memo-ems-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-gen-abd"></div>
        <textarea class="memo" id="memo-ems-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-gen-limb"></div>
        <textarea class="memo" id="memo-ems-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="ems-gen-neuro"></div>
        <textarea class="memo" id="memo-ems-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="ems-tra-head"></div>
        <textarea class="memo" id="memo-ems-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-neck"></div>
        <textarea class="memo" id="memo-ems-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-chest"></div>
        <textarea class="memo" id="memo-ems-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-tra-abd"></div>
        <textarea class="memo" id="memo-ems-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="ems-tra-pelvis"></div>
        <textarea class="memo" id="memo-ems-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-tra-limb"></div>
        <textarea class="memo" id="memo-ems-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>æ„è­˜</h3>
        <div class="chips" id="ems-str-conscious"></div>
        <h3>é¡”é¢ãƒ»ç™ºèª</h3>
        <div class="chips" id="ems-str-face"></div>
        <h3>é‹å‹•</h3>
        <div class="chips" id="ems-str-motor"></div>
        <h3>ãã®ä»–ç—‡çŠ¶</h3>
        <div class="chips" id="ems-str-other"></div>
        <label style="margin-top:12px">ç™ºç—‡æ™‚åˆ»ï¼ˆã‚ã‹ã‚Œã°ï¼‰</label>
        <div class="time-row">
          <input type="time" id="ems_stroke_onset">
          <button class="time-btn" onclick="setNow('ems_stroke_onset')">Now</button>
        </div>
        <textarea class="memo" id="memo-ems-str" placeholder="è„³å’ä¸­æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆæœ€çµ‚å¥å¸¸ç¢ºèªæ™‚åˆ»ãªã©ï¼‰"></textarea>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>åˆæœŸæ³¢å½¢</h3>
        <div class="chips" id="ems-cpa-rhythm"></div>
        <h3>ç›®æ’ƒãƒ»ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼</h3>
        <div class="chips" id="ems-cpa-witness"></div>
        <h3>æ°—é“</h3>
        <div class="chips" id="ems-cpa-airway"></div>
        <h3>å¾ªç’°</h3>
        <div class="chips" id="ems-cpa-circulation"></div>
        <h3>èƒ¸è…¹éƒ¨</h3>
        <div class="chips" id="ems-cpa-chest"></div>
        <textarea class="memo" id="memo-ems-cpa" placeholder="CPAæ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="ems_procedures"></div>
      <div id="ems_o2_amount" style="display:none;margin-top:8px">
        <label>é…¸ç´ æŠ•ä¸é‡</label>
        <select id="ems_o2_flow">
          <option value="">é¸æŠ</option>
          <option value="1L/min">1L/min</option>
          <option value="2L/min">2L/min</option>
          <option value="3L/min">3L/min</option>
          <option value="5L/min">5L/min</option>
          <option value="6L/min">6L/min</option>
          <option value="10L/min">10L/min</option>
          <option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼10L">ãƒªã‚¶ãƒ¼ãƒãƒ¼10L</option>
          <option value="ãƒªã‚¶ãƒ¼ãƒãƒ¼15L">ãƒªã‚¶ãƒ¼ãƒãƒ¼15L</option>
        </select>
      </div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="ems_procedures_detail" placeholder="ãã®ä»–ã®å‡¦ç½®"></textarea>
    </div>
  </div>

  <!-- FDæ´»å‹• -->
  <div class="card">
    <div class="card-header">ğŸ‘¨â€âš•ï¸ ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼</div>
    <div class="card-body">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addFdVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="fd_vitals_container"></div>

      <h3 style="margin-top:16px">èº«ä½“æ‰€è¦‹</h3>
      <div class="exam-tabs" id="fd_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="fd-gen-head"></div>
        <textarea class="memo" id="memo-fd-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="fd-gen-resp"></div>
        <textarea class="memo" id="memo-fd-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="fd-gen-card"></div>
        <textarea class="memo" id="memo-fd-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="fd-gen-abd"></div>
        <textarea class="memo" id="memo-fd-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="fd-gen-limb"></div>
        <textarea class="memo" id="memo-fd-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="fd-gen-neuro"></div>
        <textarea class="memo" id="memo-fd-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="fd-tra-head"></div>
        <textarea class="memo" id="memo-fd-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="fd-tra-neck"></div>
        <textarea class="memo" id="memo-fd-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="fd-tra-chest"></div>
        <textarea class="memo" id="memo-fd-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="fd-tra-abd"></div>
        <textarea class="memo" id="memo-fd-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="fd-tra-pelvis"></div>
        <textarea class="memo" id="memo-fd-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="fd-tra-limb"></div>
        <textarea class="memo" id="memo-fd-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>è„³ç¥çµŒæ‰€è¦‹</h3>
        <div class="chips" id="fd-str-cn"></div>
        <textarea class="memo" id="memo-fd-str-cn" placeholder="è„³ç¥çµŒãƒ¡ãƒ¢ï¼ˆè¦–åŠ›ãƒ»è¦–é‡ã€çœ¼çƒé‹å‹•ãªã©ï¼‰"></textarea>

        <h3>ç³å­”ãƒ»çœ¼çƒé‹å‹•</h3>
        <div class="grid2">
          <div>
            <label>ç³å­”å¾„ å·¦(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openPupilDial('L')">
              <span class="vital-value" id="pupilL_display">3</span>
            </div>
          </div>
          <div>
            <label>ç³å­”å¾„ å³(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openPupilDial('R')">
              <span class="vital-value" id="pupilR_display">3</span>
            </div>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å¯¾å…‰åå°„ å·¦</label>
            <select id="plrL">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
          <div>
            <label>å¯¾å…‰åå°„ å³</label>
            <select id="plrR">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å…±åŒåè¦–</label>
            <select id="str_gaze">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="å³æ–¹">å³æ–¹</option>
              <option value="å·¦æ–¹">å·¦æ–¹</option>
            </select>
          </div>
          <div>
            <label>çœ¼æŒ¯</label>
            <select id="str_nyst">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="æ°´å¹³">æ°´å¹³</option>
              <option value="å‚ç›´">å‚ç›´</option>
              <option value="å›æ—‹">å›æ—‹</option>
            </select>
          </div>
        </div>
        <textarea class="memo" id="memo-fd-str-eye" placeholder="çœ¼æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆè¿½è¦–éšœå®³ã€è¤‡è¦–ãªã©ï¼‰"></textarea>

        <h3>é‹å‹•ï¼ˆMMT 0-5ï¼‰</h3>
        <div class="grid2">
          <div>
            <label>å³ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('ru')">
              <span class="vital-value" id="mmt_ru_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('lu')">
              <span class="vital-value" id="mmt_lu_display">5</span>
            </div>
          </div>
          <div>
            <label>å³ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('rl')">
              <span class="vital-value" id="mmt_rl_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('ll')">
              <span class="vital-value" id="mmt_ll_display">5</span>
            </div>
          </div>
        </div>
        <textarea class="memo" id="memo-fd-str-motor" placeholder="é‹å‹•æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆç‰‡éº»ç—ºå„ªä½å´ã€ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ãƒ¼ãƒ ãªã©ï¼‰"></textarea>

        <h3>åå°„ãƒ»éŒä½“è·¯</h3>
        <div class="grid2">
          <div>
            <label>BTR</label>
            <select id="str_btr">
              <option value="">--</option>
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="äº¢é€²">äº¢é€²</option>
              <option value="ä½ä¸‹">ä½ä¸‹</option>
            </select>
          </div>
          <div>
            <label>PTR</label>
            <select id="str_ptr">
              <option value="">--</option>
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="äº¢é€²">äº¢é€²</option>
              <option value="ä½ä¸‹">ä½ä¸‹</option>
            </select>
          </div>
        </div>
        <div class="checkline" style="margin-top:8px">
          <label><input type="checkbox" id="str_babinski"> Babinskié™½æ€§</label>
          <label><input type="checkbox" id="str_chaddock"> Chaddocké™½æ€§</label>
        </div>
        <textarea class="memo" id="memo-fd-str-reflex" placeholder="åå°„ãƒ¡ãƒ¢"></textarea>

        <h3>é«˜æ¬¡è„³æ©Ÿèƒ½ãƒ»å°è„³</h3>
        <div class="chips" id="fd-str-higher"></div>
        <textarea class="memo" id="memo-fd-str-higher" placeholder="è¦‹å½“è­˜ã€å¤±èªã®å‹ã€ã‚¢ã‚¿ã‚­ã‚·ã‚¢ãªã©"></textarea>

        <details style="margin-top:12px;background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)">
          <summary style="font-weight:600;cursor:pointer">NIHSSï¼ˆã‚¿ãƒƒãƒ—ã§å±•é–‹ï¼‰<span id="nihss_sum" style="margin-left:8px;background:var(--brand);color:#fff;padding:2px 10px;border-radius:12px;font-size:13px">0ç‚¹</span></summary>
          <div style="margin-top:12px" id="nihss_area"></div>
          <label style="margin-top:8px">NIHSSãƒ¡ãƒ¢</label>
          <textarea class="memo" id="nihss_memo" placeholder="è©•ä¾¡æ™‚ã®æ³¨æ„ç‚¹"></textarea>
        </details>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
        <div id="cpa_events_container"></div>
        <button class="btn small" style="margin-top:12px" onclick="addCpaEvent()">ï¼‹ å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
      </div>

      <h3>æ¤œæŸ»</h3>
      <div class="checkline">
        <label><input type="checkbox" id="exam_bs" onchange="toggleExam('bs')"> è¡€ç³–</label>
        <label><input type="checkbox" id="exam_us" onchange="toggleExam('us')"> US</label>
        <label><input type="checkbox" id="exam_ecg" onchange="toggleExam('ecg')"> 12èª˜å°å¿ƒé›»å›³</label>
        <label><input type="checkbox" id="exam_fast" onchange="toggleExam('fast')"> FAST</label>
        <label><input type="checkbox" id="exam_efast" onchange="toggleExam('efast')"> eFAST</label>
      </div>
      <div id="exam_bs_area" style="display:none;margin-top:8px">
        <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:12px;cursor:pointer;display:inline-block;min-width:100px" onclick="openBsDial()">
          <div class="vital-value" id="fd_bs_display">120</div>
          <div class="vital-unit">mg/dL</div>
        </div>
        <input type="hidden" id="fd_bs" value="120">
      </div>
      <textarea id="exam_us_txt" placeholder="è¶…éŸ³æ³¢æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_ecg_txt" placeholder="12èª˜å°å¿ƒé›»å›³æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_fast_txt" placeholder="FASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_efast_txt" placeholder="eFASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      
      <div class="grid2" style="margin-top:8px">
        <div>
          <label>è¡€ã‚¬ã‚¹</label>
          <select id="fd_abg_type" onchange="toggleAbg()">
            <option value="">æœªå®Ÿæ–½</option>
            <option value="ABG">ABG</option>
            <option value="VBG">VBG</option>
          </select>
        </div>
      </div>
      <div id="abg_area" style="display:none;margin-top:10px">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn small" onclick="addAbgSet()">ã‚»ãƒƒãƒˆè¿½åŠ </button>
          <button class="btn small ghost" onclick="clearAbg()">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="abg_pills" class="labline"></div>
      </div>
      
      <div class="checkline">
        <label><input type="checkbox" id="exam_us" onchange="toggleExam('us')"> US</label>
        <label><input type="checkbox" id="exam_ecg" onchange="toggleExam('ecg')"> 12èª˜å°</label>
        <label><input type="checkbox" id="exam_fast" onchange="toggleExam('fast')"> FAST</label>
        <label><input type="checkbox" id="exam_efast" onchange="toggleExam('efast')"> eFAST</label>
      </div>
      <textarea id="exam_us_txt" placeholder="è¶…éŸ³æ³¢æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_ecg_txt" placeholder="å¿ƒé›»å›³æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_fast_txt" placeholder="FASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_efast_txt" placeholder="eFASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      
      <label>æ¤œæŸ»è©³ç´°</label>
      <textarea id="fd_exam_detail" placeholder="ãã®ä»–æ¤œæŸ»æ‰€è¦‹"></textarea>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="fd_procedures"></div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="fd_procedure_detail" placeholder="å‡¦ç½®ã®è©³ç´°"></textarea>

      <h3>è–¬å‰¤æŠ•ä¸</h3>
      <div class="chips" id="fd_drugs"></div>
      <label>è–¬å‰¤è©³ç´°</label>
      <textarea id="fd_drug_detail" placeholder="æŠ•ä¸é‡ã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°"></textarea>
    </div>
  </div>

  <!-- è©•ä¾¡ -->
  <div class="card">
    <div class="card-header">ğŸ“‹ è©•ä¾¡</div>
    <div class="card-body">
      <h3>ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆ</h3>
      <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
        <input type="text" id="new_problem" placeholder="ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ã‚’å…¥åŠ›" style="flex:1">
        <button class="btn small" style="padding:10px 12px;width:auto;flex-shrink:0" onclick="addProblem()">è¿½åŠ </button>
      </div>
      <div id="problems"></div>
      
      <label>è€ƒå¯Ÿ</label>
      <textarea id="consideration" placeholder="ç—…æ…‹ç”Ÿç†ã‚„è‡¨åºŠæ¨è«–"></textarea>
    </div>
  </div>

  <!-- æ¬é€å…ˆ -->
  <div class="card">
    <div class="card-header">ğŸ¥ æ¬é€å…ˆ</div>
    <div class="card-body">
      <label>åŒ»ç™‚æ©Ÿé–¢ï¼ˆç°¡æ˜“é¸æŠï¼‰</label>
      <div class="chips" id="destination_chips"></div>
      <label>ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
      <input type="text" id="destination_custom" placeholder="ä¸Šè¨˜ä»¥å¤–ã®åŒ»ç™‚æ©Ÿé–¢åã‚’å…¥åŠ›">
      <div id="destination_display" style="margin-top:8px;padding:10px;background:#e0f2fe;border-radius:8px;display:none">
        <span style="font-size:13px;color:#0369a1">é¸æŠä¸­ï¼š</span>
        <strong id="destination_selected"></strong>
      </div>
      <label style="margin-top:12px">é¸å®šç†ç”±</label>
      <textarea id="selection_reason" placeholder="æ¬é€å…ˆé¸å®šã®ç†ç”±"></textarea>
      
      <h3>æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
      <select id="turn_type">
        <option value="Iã‚¿ãƒ¼ãƒ³">Iã‚¿ãƒ¼ãƒ³</option>
        <option value="Jã‚¿ãƒ¼ãƒ³">Jã‚¿ãƒ¼ãƒ³</option>
        <option value="Uã‚¿ãƒ¼ãƒ³">Uã‚¿ãƒ¼ãƒ³</option>
      </select>
      
      <div id="transport_times" style="display:none">
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>æ¬é€é›¢é™¸</label>
            <div class="time-row">
              <input type="time" id="transport_takeoff">
              <button class="time-btn" onclick="setNow('transport_takeoff')">Now</button>
            </div>
          </div>
          <div>
            <label>ç—…é™¢ç€</label>
            <div class="time-row">
              <input type="time" id="hospital_arrival">
              <button class="time-btn" onclick="setNow('hospital_arrival')">Now</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å‡ºåŠ› -->
  <div class="card">
    <div class="card-header">ğŸ“„ æ´»å‹•è¨˜éŒ²</div>
    <div class="card-body">
      <div class="result" id="outText"></div>
    </div>
  </div>
</main>

<!-- ä¸‹éƒ¨ãƒŠãƒ“ -->
<div class="bottom-nav">
  <button class="btn" id="copyOut">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  <button class="btn ghost" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
  <button class="btn ghost" onclick="loadData()">ğŸ“‚ èª­è¾¼</button>
  <button class="btn ghost" onclick="resetData()" style="color:#dc2626">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<!-- ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ -->
<div class="dial-overlay" id="dialOverlay" onclick="closeDial(event)">
  <div class="dial-container" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()">
    <div class="dial-header">
      <span class="dial-title" id="dialTitle">å€¤ã‚’é¸æŠ</span>
      <button class="dial-done" onclick="confirmDial()">å®Œäº†</button>
    </div>
    <div class="dial-body" id="dialBody"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// æ‰€è¦‹å®šç¾©
const EMS_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”è‰²è‰¯å¥½'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','å†·æ±—','ç™ºç†±']},
  resp: {normal:['å‘¼å¸å®‰å®š','å‘¼å¸è‹¦ãªã—'], abn:['å‘¼å¸å›°é›£','åŠªåŠ›å‘¼å¸','é »å‘¼å¸','èµ·åå‘¼å¸','é™¥æ²¡å‘¼å¸']},
  card: {normal:['è„ˆæ‹æ•´','æœ«æ¢¢æ¸©ã‹ã„'], abn:['è„ˆæ‹ä¸æ•´','é »è„ˆ','å¾è„ˆ','æœ«æ¢¢å†·æ„Ÿ','å†·æ±—']},
  abd: {normal:['è…¹éƒ¨å¹³å¦','åœ§ç—›ãªã—'], abn:['è…¹éƒ¨è†¨æº€','åœ§ç—›','ç­‹æ€§é˜²å¾¡','å˜”å']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','ä¸‹è…¿æµ®è…«','å¤‰å½¢']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”å·¦å³å·®']}
};
const EMS_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²','å‰é¡éƒ¨è¡€è…«','å‰é¡éƒ¨æŒ«å‰µ','å´é ­éƒ¨æ‰“æ’²','å´é ­éƒ¨è¡€è…«','å¾Œé ­éƒ¨æ‰“æ’²','å¾Œé ­éƒ¨æŒ«å‰µ','é¡”é¢æ‰“æ’²','é¡”é¢æŒ«å‰µ','é¡”é¢å¤‰å½¢','çœ¼å‘¨å›²è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·']},
  neck: {normal:['å¾Œé ¸éƒ¨åœ§ç—›ãªã—','æ°—ç®¡åä½ãªã—'], abn:['é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','æ°—ç®¡åä½']},
  chest: {normal:['å‘¼å¸éŸ³å·¦å³å·®ãªã—'], abn:['èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±']},
  abd: {normal:[], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','è…¹éƒ¨åœ§ç—›','è…¹éƒ¨è†¨æº€','ç­‹æ€§é˜²å¾¡','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—'], abn:['éª¨ç›¤åœ§ç—›','éª¨ç›¤å‹•æº','ä¼šé™°éƒ¨å‡ºè¡€','ä¸‹è…¹éƒ¨è†¨æº€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['ä¸Šè‚¢æ‰“æ’²','ä¸Šè‚¢æŒ«å‰µ','ä¸Šè‚¢å¤‰å½¢','ä¸Šè‚¢è…«è„¹','ä¸‹è‚¢æ‰“æ’²','ä¸‹è‚¢æŒ«å‰µ','ä¸‹è‚¢å¤‰å½¢','ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','æœ«æ¢¢å†·æ„Ÿ','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯']}
};
const EMS_CPA_GROUPS = {
  rhythm: {normal:[], abn:['Vf','Pulseless VT','PEA','Asystole']},
  witness: {normal:['ç›®æ’ƒã‚ã‚Š','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š'], abn:['ç›®æ’ƒãªã—','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—']},
  airway: {normal:['å£è…”å†…ç•°ç‰©ãªã—','æ°—é“é–‹é€šè‰¯å¥½'], abn:['å£è…”å†…ç•°ç‰©','æ°—é“é–‰å¡','åç‰©','å‡ºè¡€']},
  circulation: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','æ©ˆéª¨å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  chest: {normal:['èƒ¸éƒ­æŒ™ä¸Šè‰¯å¥½','å‘¼å¸éŸ³å·¦å³å·®ãªã—','è…¹éƒ¨è†¨éš†ãªã—'], abn:['èƒ¸éƒ­æŒ™ä¸Šä¸è‰¯','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','çš®ä¸‹æ°—è…«','è…¹éƒ¨è†¨éš†','ä¸‹è…¿æµ®è…«']}
};
const EMS_STR_GROUPS = {
  conscious: {normal:['æ„è­˜æ¸…æ˜'], abn:['æ„è­˜éšœå®³','JCS 1æ¡','JCS 2æ¡','JCS 3æ¡']},
  face: {normal:['é¡”é¢éº»ç—ºãªã—','æ§‹éŸ³éšœå®³ãªã—'], abn:['é¡”é¢éº»ç—º','æ§‹éŸ³éšœå®³','å‘‚å¾‹éšœå®³']},
  motor: {normal:['ä¸Šè‚¢æŒ™ä¸Šä¿æŒå¯','ä¸‹è‚¢æŒ™ä¸Šä¿æŒå¯'], abn:['ä¸Šè‚¢æŒ™ä¸Šä¸å¯(å³)','ä¸Šè‚¢æŒ™ä¸Šä¸å¯(å·¦)','ä¸‹è‚¢æŒ™ä¸Šä¸å¯(å³)','ä¸‹è‚¢æŒ™ä¸Šä¸å¯(å·¦)','ç‰‡éº»ç—º(å³)','ç‰‡éº»ç—º(å·¦)']},
  other: {normal:[], abn:['ç³å­”ä¸åŒ','å…±åŒåè¦–','é ­ç—›','å˜”å','ã‚ã¾ã„','ç—™æ”£','å¤±èª']}
};
const FD_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”é¢è’¼ç™½ãªã—','ãƒã‚¢ãƒãƒ¼ã‚¼ãªã—'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','ç™ºç†±']},
  resp: {normal:['å‘¼å¸éŸ³æ¸…','å–˜é³´ãªã—'], abn:['å‘¼å¸å›°é›£','å–˜é³´','æ¹¿æ€§ãƒ©éŸ³','coarse crackles','fine crackles']},
  card: {normal:['å¿ƒéŸ³ç´”','ä¸æ•´ãªã—','ä¸‹è…¿æµ®è…«ãªã—'], abn:['ã‚·ãƒ§ãƒƒã‚¯å…†å€™','å¿ƒé›‘éŸ³','ä¸æ•´è„ˆ','å†·æ±—','ä¸‹è…¿æµ®è…«']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ','åœ§ç—›ãªã—','åè·³ç—›ãªã—'], abn:['è…¹ç—›','åœ§ç—›','åè·³ç—›','ç­‹æ€§é˜²å¾¡','æ¿çŠ¶ç¡¬']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','æµ®è…«','å¤‰å½¢','æœ«æ¢¢å¾ªç’°ä¸å…¨']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”ä¸åŒ','å¯¾å…‰åå°„ç•°å¸¸']}
};
const FD_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²è¡€è…«','å´é ­éƒ¨æ‰“æ’²è¡€è…«','å¾Œé ­éƒ¨æŒ«å‰µ','é ­çš®è£‚å‚·','é¡”é¢æŒ«å‰µ','é¡”é¢è…«è„¹','ãƒ‘ãƒ³ãƒ€ã®ç›®å¾´å€™','ãƒãƒˆãƒ«ã‚µã‚¤ãƒ³','é¼»æ ¹éƒ¨è…«è„¹','å³é ¬éƒ¨å¤‰å½¢è…«è„¹','å·¦é ¬éƒ¨å¤‰å½¢è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','é«„æ¶²è€³æ¼','é«„æ¶²é¼»æ¼','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·','çµè†œå‡ºè¡€','è§’è†œæå‚·','çœ¼çƒåä½','è¤‡è¦–']},
  neck: {normal:['æ°—ç®¡æ­£ä¸­','é ¸éƒ¨çš®ä¸‹æ°—è…«ãªã—','é ¸é™è„ˆæ€’å¼µãªã—','å¾Œé ¸éƒ¨åœ§ç—›ãªã—'], abn:['æ°—ç®¡åä½','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','é ¸éƒ¨è¡€è…«']},
  chest: {normal:['èƒ¸éƒ­å¯¾ç§°','å‘¼å¸éŸ³æ¸…å·¦å³å·®ãªã—','å¿ƒéŸ³æ•´'], abn:['èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','å³å‘¼å¸éŸ³æ¶ˆå¤±','å·¦å‘¼å¸éŸ³æ¶ˆå¤±','å¿ƒéŸ³æ¸›å¼±']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ'], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•','è…¹éƒ¨åœ§ç—›','å³ä¸Šè…¹éƒ¨åœ§ç—›','å·¦ä¸Šè…¹éƒ¨åœ§ç—›','ä¸‹è…¹éƒ¨åœ§ç—›','ç­‹æ€§é˜²å¾¡','åè·³ç—›','è…¹éƒ¨è†¨æº€','è…¸è •å‹•éŸ³æ¸›å¼±']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—','ç›´è…¸è¨ºç•°å¸¸ãªã—'], abn:['éª¨ç›¤å‹•æº','éª¨ç›¤åœ§ç—›','æ¥éª¨åœ§ç—›','ä¼šé™°éƒ¨å‡ºè¡€','å°¿é“å‡ºè¡€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['å³ä¸Šè‚¢æ‰“æ’²','å³ä¸Šè‚¢æŒ«å‰µ','å³ä¸Šè‚¢å¤‰å½¢','å³ä¸Šè‚¢è…«è„¹','å·¦ä¸Šè‚¢æ‰“æ’²','å·¦ä¸Šè‚¢æŒ«å‰µ','å·¦ä¸Šè‚¢å¤‰å½¢','å·¦ä¸Šè‚¢è…«è„¹','å³ä¸‹è‚¢æ‰“æ’²','å³ä¸‹è‚¢æŒ«å‰µ','å³ä¸‹è‚¢å¤‰å½¢','å³ä¸‹è‚¢è…«è„¹','å·¦ä¸‹è‚¢æ‰“æ’²','å·¦ä¸‹è‚¢æŒ«å‰µ','å·¦ä¸‹è‚¢å¤‰å½¢','å·¦ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','éª¨éœ²å‡º','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯','æœ«æ¢¢å†·æ„Ÿ','CRTå»¶é•·']}
};
const FD_STR_GROUPS = {
  cn: {normal:[], abn:['è¦–åŠ›ä½ä¸‹','è¦–é‡æ¬ æ','è¤‡è¦–','çœ¼ç¼ä¸‹å‚','é¡”é¢éº»ç—º','é¡”é¢æ„Ÿè¦šä½ä¸‹','è´åŠ›ä½ä¸‹','ã‚ã¾ã„','æ§‹éŸ³éšœå®³','åš¥ä¸‹éšœå®³','èˆŒåä½','ã‚«ãƒ¼ãƒ†ãƒ³å¾´å€™']},
  higher: {normal:[], abn:['å¤±èª','é‹å‹•æ€§å¤±èª','æ„Ÿè¦šæ€§å¤±èª','æ§‹éŸ³éšœå®³','å¤±è¡Œ','å¤±èª','åŠå´ç©ºé–“ç„¡è¦–','æ³¨æ„éšœå®³','è¦‹å½“è­˜éšœå®³','å°è„³å¤±èª¿','æŒ‡é¼»è©¦é¨“ç•°å¸¸','è¸µè†è©¦é¨“ç•°å¸¸']}
};
const FD_CPA_GROUPS = {
  body: {normal:[], abn:['å¿ƒåœæ­¢','å‘¼å¸åœæ­¢','ãƒã‚¢ãƒãƒ¼ã‚¼','å››è‚¢å†·æ„Ÿ','çš®è†šè’¼ç™½','æ­»æ–‘','æ­»å¾Œç¡¬ç›´']},
  head: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  trunk: {normal:[], abn:['å¿ƒéŸ³è´å–ä¸å¯','å‘¼å¸éŸ³è´å–ä¸å¯','è…¹éƒ¨è†¨éš†']}
};

// çŠ¶æ…‹
let state = {
  request: {type:'', detail:'', time:''},
  patient: {history:'', medication:'', allergy:'', lastMeal:'', hospital:''},
  heli: {takeoff:'', lz_landing:'', fd_contact:'', turn_type:'Iã‚¿ãƒ¼ãƒ³', transport_takeoff:'', hospital_arrival:''},
  ems: {
    aware:'', arrival:'', contact:'', departure:'', lz:'',
    vitals: [],
    exam_tab: 'general',
    chips: {},
    memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{memo:''},cpa:{memo:''}},
    stroke_onset: '',
    procedures: {},
    procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'],
    o2_flow:'', procedures_detail:''
  },
  fd: {
    vitals: [],
    exam_tab: 'general',
    chips: {},
    memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{neuro:'',motor:'',eye:'',higher:''},cpa:{body:'',head:'',trunk:''}},
    exams: {bs:false, us:false, ecg:false, fast:false, efast:false},
    exam_texts: {us:'', ecg:'', fast:'', efast:''},
    bs:120, abg_type:'', abg_data: [], exam_detail:'',
    cpaEvents: [],
    stroke: {
      pupilL:3, pupilR:3, plrL:'', plrR:'', gaze:'', nyst:'',
      mmt:{ru:5, lu:5, rl:5, ll:5},
      btr:'', ptr:'', babinski:false, chaddock:false,
      nihss:{}, nihssMemo:''
    },
    procedures: {},
    procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'],
    procedure_detail:'',
    drugs: {},
    drugs_items: ['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹'],
    drug_detail:''
  },
  problems: [],
  consideration: '',
  destination: {hospital:'', custom:'', reason:''},
  hospitals: {
    'é¹¿å…å³¶': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','å—é¢¨ç—…é™¢','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢'],
    'å—è–©': ['æŒ‡å®¿åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ä»Šæ—æ•´å½¢å¤–ç§‘ç—…é™¢','å±±å·ç—…é™¢','å°åŸç—…é™¢','åŠ ä¸–ç”°ç—…é™¢','èŠé‡ç—…é™¢','ä¹…æœ¨ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','çœŒç«‹è–©å—ç—…é™¢','ã‚µã‚¶ãƒ³ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç—…é™¢','åŠæ´¥ç—…é™¢','æ•å´å¸‚ç«‹ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ‰é¦¬ç—…é™¢'],
    'å·è–©': ['æ¸ˆç”Ÿä¼šå·å†…ç—…é™¢','å·å†…å¸‚åŒ»å¸«ä¼šç«‹å¸‚æ°‘ç—…é™¢','å“ç¿”ä¼šè¨˜å¿µç—…é™¢','ä¸Šæ‘ç—…é™¢','é«˜æ±Ÿè¨˜å¿µç—…é™¢','æ£®åœ’è¨˜å¿µç—…é™¢','è‹¥æ¾è¨˜å¿µç—…é™¢','è–©æ‘©éƒ¡åŒ»å¸«ä¼šç—…é™¢'],
    'å‡ºæ°´': ['å‡ºæ°´éƒ¡åŒ»å¸«ä¼šåºƒåŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å‡ºæ°´ç·åˆåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å†…å±±ç—…é™¢'],
    'éœ§å³¶': ['éœ§å³¶å¸‚ç«‹åŒ»å¸«ä¼šåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å›½åˆ†ç”Ÿå”ç—…é™¢','éœ§å³¶è¨˜å¿µç—…é™¢','å¤§äº•ç—…é™¢','åŠ æ²»æœ¨æ•´å½¢å¤–ç§‘ç—…é™¢','åŠ æ²»æœ¨æ¸©æ³‰ç—…é™¢','éœ§å³¶æ‰å®‰ç—…é™¢','éœ§å³¶æ•´å½¢å¤–ç§‘ç—…é™¢','å›½åˆ†ä¸­å¤®ç—…é™¢','å›½åˆ†è„³ç¥çµŒå¤–ç§‘ç—…é™¢','é’é›²ä¼šç—…é™¢','çœŒç«‹åŒ—è–©ç—…é™¢','æ•´å½¢å¤–ç§‘æ¾å…ƒç—…é™¢','å¯ºç”°ç—…é™¢'],
    'æ›½æ–¼': ['æ˜­å—ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯åˆ†é™¢','ã³ã‚ã†ã®æ¨¹è„³ç¥çµŒå¤–ç§‘'],
    'è‚å±': ['çœŒæ°‘å¥åº·ãƒ—ãƒ©ã‚¶é¹¿å±‹åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å¤§éš…é¹¿å±‹ç—…é™¢','æ± ç”°ç—…é™¢','ã‹ã®ã‚„æ±ç—…é™¢','è‚å±éƒ¡åŒ»å¸«ä¼šç«‹ç—…é™¢','è‚ä»˜ç”ºç«‹ç—…é™¢','æ’å¿ƒä¼šãŠãã‚‰ç—…é™¢','å‚æ°´ä¸­å¤®ç—…é™¢','é»æ˜è„³ç¥çµŒå¤–ç§‘åŒ»é™¢','å¾³ç”°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','ã³ã‚ã†ã®æ¨¹'],
    'ç†Šæ¯›': ['ç¨®å­å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å±‹ä¹…å³¶å¾³æ´²ä¼šç—…é™¢'],
    'å¥„ç¾': ['çœŒç«‹å¤§å³¶ç—…é™¢','å¥„ç¾ä¸­å¤®ç—…é™¢','åç€¬å¾³æ´²ä¼šç—…é™¢','ç€¬æˆ¸å†…å¾³æ´²ä¼šç—…é™¢','å¾³ä¹‹å³¶å¾³æ´²ä¼šç—…é™¢','æ²–æ°¸è‰¯éƒ¨å¾³æ´²ä¼šç—…é™¢','å–œç•Œå¾³æ´²ä¼šç—…é™¢','å—æºŸä¼šå®®ä¸Šç—…é™¢','ä¸è«–å¾³æ´²ä¼šç—…é™¢']
  }
};

// ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼
let dialCallback = null;
let dialWheels = [];

let scrollPosition = 0;

function openDial(title, wheels, callback) {
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
  scrollPosition = window.pageYOffset;
  document.body.classList.add('dial-open');
  document.body.style.top = `-${scrollPosition}px`;
  
  dialCallback = callback;
  dialWheels = wheels;
  $('#dialTitle').textContent = title;
  const body = $('#dialBody');
  body.innerHTML = '';
  
  wheels.forEach((w, wi) => {
    const wheel = document.createElement('div');
    wheel.className = 'dial-wheel';
    wheel.innerHTML = '<div class="dial-highlight"></div>';
    
    const scroll = document.createElement('div');
    scroll.className = 'dial-scroll';
    scroll.dataset.wheelIndex = wi;
    
    w.options.forEach((opt, oi) => {
      const div = document.createElement('div');
      div.className = 'dial-option';
      div.textContent = opt.label;
      div.dataset.value = opt.value;
      div.dataset.index = oi;
      if(opt.value == w.selected) div.classList.add('selected');
      scroll.appendChild(div);
    });
    
    wheel.appendChild(scroll);
    body.appendChild(wheel);
    
    if(w.unit) {
      const unit = document.createElement('div');
      unit.className = 'dial-unit';
      unit.textContent = w.unit;
      body.appendChild(unit);
    }
    
    // ç¾åœ¨ã®é¸æŠä½ç½®ã‚’è¨˜æ†¶
    let currentIndex = w.options.findIndex(o => o.value == w.selected);
    if(currentIndex < 0) currentIndex = 0;
    
    // ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆåŠ é€Ÿåº¦ä»˜ãï¼‰
    let startY = 0, lastY = 0, lastTime = 0;
    let currentOffset = -currentIndex * 40;
    let velocityY = 0;
    let animationId = null;
    
    const stopAnimation = () => {
      if(animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    };
    
    const snapToNearest = () => {
      const optionHeight = 40;
      let newIndex = Math.round(-currentOffset / optionHeight);
      newIndex = Math.max(0, Math.min(w.options.length - 1, newIndex));
      
      currentOffset = -newIndex * optionHeight;
      currentIndex = newIndex;
      w.selected = w.options[newIndex].value;
      
      scroll.style.transition = 'transform 0.2s ease-out';
      scroll.style.transform = `translateY(${currentOffset}px)`;
      updateDialSelection(scroll, newIndex);
    };
    
    const momentumScroll = () => {
      // æ¸›é€Ÿä¿‚æ•°ï¼ˆå°ã•ã„ã»ã©é•·ãæ»‘ã‚‹ï¼‰
      const friction = 0.92;
      // æœ€å°é€Ÿåº¦
      const minVelocity = 0.5;
      
      velocityY *= friction;
      currentOffset += velocityY;
      
      // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
      const maxOffset = 0;
      const minOffset = -(w.options.length - 1) * 40;
      
      if(currentOffset > maxOffset) {
        currentOffset = maxOffset;
        velocityY = 0;
      } else if(currentOffset < minOffset) {
        currentOffset = minOffset;
        velocityY = 0;
      }
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      // é€Ÿåº¦ãŒååˆ†å°ã•ããªã£ãŸã‚‰ã‚¹ãƒŠãƒƒãƒ—
      if(Math.abs(velocityY) > minVelocity) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    };
    
    scroll.addEventListener('touchstart', e => {
      e.preventDefault();
      stopAnimation();
      scroll.style.transition = 'none';
      startY = e.touches[0].clientY;
      lastY = startY;
      lastTime = Date.now();
      velocityY = 0;
    }, {passive: false});
    
    scroll.addEventListener('touchmove', e => {
      e.preventDefault();
      const y = e.touches[0].clientY;
      const dy = y - lastY;
      
      // åŠ é€Ÿåº¦ä¿‚æ•°ï¼ˆæŒ‡ã®å‹•ãã‚’å¢—å¹…ï¼‰
      const acceleration = 1.5;
      currentOffset += dy * acceleration;
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      // é€Ÿåº¦è¨ˆç®—ï¼ˆåŠ é€Ÿåº¦ã‚’åæ˜ ï¼‰
      const now = Date.now();
      const dt = now - lastTime;
      if(dt > 0) {
        velocityY = (dy * acceleration) / dt * 16; // 60fpsã«æ­£è¦åŒ–
      }
      
      lastY = y;
      lastTime = now;
    }, {passive: false});
    
    scroll.addEventListener('touchend', e => {
      e.preventDefault();
      
      // é€Ÿåº¦ãŒååˆ†ã‚ã‚Œã°æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      if(Math.abs(velocityY) > 2) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    }, {passive: false});
    
    // ãƒã‚¦ã‚¹æ“ä½œå¯¾å¿œ
    let isMouseDown = false;
    
    scroll.addEventListener('mousedown', e => {
      e.preventDefault();
      isMouseDown = true;
      stopAnimation();
      scroll.style.transition = 'none';
      startY = e.clientY;
      lastY = startY;
      lastTime = Date.now();
      velocityY = 0;
    });
    
    document.addEventListener('mousemove', e => {
      if(!isMouseDown) return;
      e.preventDefault();
      const y = e.clientY;
      const dy = y - lastY;
      
      const acceleration = 1.5;
      currentOffset += dy * acceleration;
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      const now = Date.now();
      const dt = now - lastTime;
      if(dt > 0) {
        velocityY = (dy * acceleration) / dt * 16;
      }
      
      lastY = y;
      lastTime = now;
    });
    
    document.addEventListener('mouseup', e => {
      if(!isMouseDown) return;
      isMouseDown = false;
      
      if(Math.abs(velocityY) > 2) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    });
    
    // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«å¯¾å¿œ
    wheel.addEventListener('wheel', e => {
      e.preventDefault();
      stopAnimation();
      scroll.style.transition = 'none';
      
      currentOffset -= e.deltaY * 0.5;
      
      // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
      const maxOffset = 0;
      const minOffset = -(w.options.length - 1) * 40;
      currentOffset = Math.max(minOffset, Math.min(maxOffset, currentOffset));
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      clearTimeout(wheel.snapTimeout);
      wheel.snapTimeout = setTimeout(snapToNearest, 150);
    }, {passive: false});
    
    // ã‚¯ãƒªãƒƒã‚¯ã§ç›´æ¥é¸æŠï¼†è‡ªå‹•æ±ºå®š
    scroll.querySelectorAll('.dial-option').forEach((opt, oi) => {
      opt.addEventListener('click', e => {
        e.stopPropagation();
        currentIndex = oi;
        currentOffset = -oi * 40;
        w.selected = w.options[oi].value;
        scroll.style.transition = 'transform 0.2s ease-out';
        scroll.style.transform = `translateY(${currentOffset}px)`;
        updateDialSelection(scroll, oi);
        
        // å˜ä¸€ãƒ›ã‚¤ãƒ¼ãƒ«ã®å ´åˆã¯å³ç¢ºå®š
        if(dialWheels.length === 1) {
          setTimeout(confirmDial, 200);
        }
      });
    });
    
    // åˆæœŸä½ç½®è¨­å®šï¼ˆé¸æŠå€¤ã‚’ä¸­å¤®ã«ï¼‰
    scroll.style.transform = `translateY(${currentOffset}px)`;
    updateDialSelection(scroll, currentIndex);
  });
  
  $('#dialOverlay').classList.add('show');
  
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ã®ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
  $('#dialOverlay').ontouchmove = e => e.preventDefault();
}

function updateDialSelection(scroll, index) {
  scroll.querySelectorAll('.dial-option').forEach((o, i) => {
    o.classList.toggle('selected', i === index);
  });
  const wi = parseInt(scroll.dataset.wheelIndex);
  dialWheels[wi].selected = dialWheels[wi].options[index].value;
}

function closeDial(e) {
  if(e && e.target !== $('#dialOverlay')) return;
  $('#dialOverlay').classList.remove('show');
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  document.body.classList.remove('dial-open');
  document.body.style.top = '';
  window.scrollTo(0, scrollPosition);
}

function confirmDial() {
  if(dialCallback) {
    const values = dialWheels.map(w => w.selected);
    dialCallback(values);
  }
  $('#dialOverlay').classList.remove('show');
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  document.body.classList.remove('dial-open');
  document.body.style.top = '';
  window.scrollTo(0, scrollPosition);
}

// ãƒã‚¤ã‚¿ãƒ«ç”¨ãƒ€ã‚¤ãƒ¤ãƒ«
function openVitalDial(type, idx, field) {
  const v = state[type].vitals[idx];
  let wheels = [];
  let title = '';
  
  switch(field) {
    case 'bp':
      title = 'è¡€åœ§';
      wheels = [
        {options: genRange(0, 250, 1), selected: v.sbp, unit: '/'},
        {options: genRange(0, 150, 1), selected: v.dbp, unit: 'mmHg'}
      ];
      break;
    case 'hr':
      title = 'å¿ƒæ‹æ•°';
      wheels = [{options: genRange(0, 250, 1), selected: v.hr, unit: 'bpm'}];
      break;
    case 'rr':
      title = 'å‘¼å¸æ•°';
      wheels = [{options: genRange(0, 45, 1), selected: v.rr, unit: '/min'}];
      break;
    case 'spo2':
      title = 'SpOâ‚‚';
      wheels = [{options: genRange(40, 100, 1), selected: v.spo2, unit: '%'}];
      break;
    case 'bt':
      title = 'ä½“æ¸©';
      wheels = [{options: genRangeBT(), selected: v.bt, unit: 'â„ƒ'}];
      break;
    case 'gcs_e':
      title = 'GCS - E';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4}], selected: v.gcs.e}];
      break;
    case 'gcs_v':
      title = 'GCS - V';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4},{label:'5',value:5},{label:'T',value:'T'}], selected: v.gcs.v}];
      break;
    case 'gcs_m':
      title = 'GCS - M';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4},{label:'5',value:5},{label:'6',value:6}], selected: v.gcs.m}];
      break;
    case 'jcs':
      title = 'JCS';
      wheels = [{options: [
        {label:'0 (æ¸…æ˜)',value:'0'},{label:'I-1',value:'1'},{label:'I-2',value:'2'},{label:'I-3',value:'3'},
        {label:'II-10',value:'10'},{label:'II-20',value:'20'},{label:'II-30',value:'30'},
        {label:'III-100',value:'100'},{label:'III-200',value:'200'},{label:'III-300',value:'300'}
      ], selected: v.jcs}];
      break;
  }
  
  openDial(title, wheels, vals => {
    switch(field) {
      case 'bp': v.sbp = vals[0]; v.dbp = vals[1]; break;
      case 'hr': v.hr = vals[0]; break;
      case 'rr': v.rr = vals[0]; break;
      case 'spo2': v.spo2 = vals[0]; break;
      case 'bt': v.bt = vals[0]; break;
      case 'gcs_e': v.gcs.e = vals[0]; break;
      case 'gcs_v': v.gcs.v = vals[0]; break;
      case 'gcs_m': v.gcs.m = vals[0]; break;
      case 'jcs': v.jcs = vals[0]; break;
    }
    if(type === 'ems') renderEmsVitals();
    else renderFdVitals();
    updateState();
  });
}

function genRange(from, to, step) {
  const arr = [];
  for(let i = from; i <= to; i += step) {
    arr.push({label: String(i), value: i});
  }
  return arr;
}

function genRangeBT() {
  const arr = [];
  for(let i = 32.0; i <= 42.0; i += 0.1) {
    arr.push({label: i.toFixed(1), value: parseFloat(i.toFixed(1))});
  }
  return arr;
}

// è¡€ç³–å€¤ãƒ€ã‚¤ãƒ¤ãƒ«
function openBsDial() {
  const currentBs = state.fd.bs || 120;
  const wheels = [{options: genRange(0, 600, 1), selected: currentBs, unit: 'mg/dL'}];
  
  openDial('è¡€ç³–å€¤', wheels, vals => {
    state.fd.bs = vals[0];
    $('#fd_bs').value = vals[0];
    $('#fd_bs_display').textContent = vals[0];
    updateState();
  });
}

// ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æ™‚åˆ»è¿½åŠ 
// CPA ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
function addCpaEvent() {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  const newEvent = {
    arrestTime: time,
    rhythm: 'Asystole',
    witnessed: false,
    bystander: false,
    cprStart: '',
    ivTime: '',
    adrenalineTimes: [],
    lt: false,
    intubation: false,
    intubationTime: '',
    pericardio: false,
    pericardioTime: '',
    roscTime: '',
    memo: ''
  };
  
  state.fd.cpaEvents.push(newEvent);
  renderCpaEvents();
  updateState();
}

function deleteCpaEvent(idx) {
  if(confirm('ã“ã®å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
    state.fd.cpaEvents.splice(idx, 1);
    renderCpaEvents();
    updateState();
  }
}

function renderCpaEvents() {
  const container = $('#cpa_events_container');
  if(!container) return;
  container.innerHTML = '';
  
  if(state.fd.cpaEvents.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }
  
  state.fd.cpaEvents.forEach((event, idx) => {
    const card = document.createElement('div');
    card.className = 'vital-card';
    card.style.marginBottom = '12px';
    
    // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
    if(idx === 0) {
      card.innerHTML = `
      <div class="vital-header">
        <div style="font-weight:600">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}${event.roscTime ? ' (ROSC)' : ''}</div>
        <button class="vital-del" onclick="deleteCpaEvent(${idx})">å‰Šé™¤</button>
      </div>
      <div style="padding:12px">
        <div class="grid2" style="margin-bottom:12px">
          <div>
            <label>å¿ƒåœæ­¢æ™‚åˆ»</label>
            <div class="time-row">
              <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'arrestTime')">Now</button>
            </div>
          </div>
          <div>
            <label>åˆæœŸæ³¢å½¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;text-align:center" onclick="openCpaRhythmDial(${idx})">
              <div class="vital-value" style="font-size:16px">${event.rhythm}</div>
            </div>
          </div>
        </div>
        
        <div class="grid2" style="margin-top:12px">
          <div class="toggle-btn ${event.witnessed ? 'active' : ''}" onclick="toggleCpaField(${idx}, 'witnessed')">
            ${event.witnessed ? 'ç›®æ’ƒã‚ã‚Š' : 'ç›®æ’ƒãªã—'}
          </div>
          <div class="toggle-btn ${event.bystander ? 'active' : ''}" onclick="toggleCpaField(${idx}, 'bystander')">
            ${event.bystander ? 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š' : 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—'}
          </div>
        </div>
        
        <h3 style="margin-top:12px">è˜‡ç”Ÿå‡¦ç½®</h3>
        <div class="grid2">
          <div>
            <label>èƒ¸éª¨åœ§è¿«é–‹å§‹</label>
            <div class="time-row">
              <input type="time" value="${event.cprStart}" onchange="updateCpaEventField(${idx}, 'cprStart', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'cprStart')">Now</button>
            </div>
          </div>
          <div>
            <label>æœ«æ¢¢ç¢ºä¿</label>
            <div class="time-row">
              <input type="time" value="${event.ivTime}" onchange="updateCpaEventField(${idx}, 'ivTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'ivTime')">Now</button>
            </div>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸</h3>
        <div id="adrenaline_times_${idx}"></div>
        <button class="btn small" style="margin-top:8px" onclick="addAdrenalineTime(${idx})">ï¼‹ ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³è¿½åŠ </button>
        
        <h3 style="margin-top:12px">æ°—é“ç¢ºä¿</h3>
        <div class="checkline">
          <label><input type="checkbox" ${event.lt ? 'checked' : ''} onchange="updateCpaEventField(${idx}, 'lt', this.checked)"> LTæŒ¿å…¥</label>
        </div>
        <div class="checkline" style="margin-top:8px">
          <label><input type="checkbox" ${event.intubation ? 'checked' : ''} onchange="toggleCpaIntubation(${idx})"> æ°—ç®¡æŒ¿ç®¡</label>
        </div>
        <div id="cpa_intubation_time_area_${idx}" style="${event.intubation ? '' : 'display:none'};margin-top:8px">
          <div class="time-row">
            <input type="time" value="${event.intubationTime}" onchange="updateCpaEventField(${idx}, 'intubationTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'intubationTime')">Now</button>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ãã®ä»–å‡¦ç½®</h3>
        <div class="checkline">
          <label><input type="checkbox" ${event.pericardio ? 'checked' : ''} onchange="toggleCpaPericardio(${idx})"> å¿ƒè†œè…”ç©¿åˆº</label>
        </div>
        <div id="cpa_pericardio_time_area_${idx}" style="${event.pericardio ? '' : 'display:none'};margin-top:8px">
          <div class="time-row">
            <input type="time" value="${event.pericardioTime}" onchange="updateCpaEventField(${idx}, 'pericardioTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'pericardioTime')">Now</button>
          </div>
        </div>
        
        <h3 style="margin-top:12px">è»¢å¸°</h3>
        <div>
          <label>å¿ƒæ‹å†é–‹(ROSC)æ™‚åˆ»</label>
          <div class="time-row">
            <input type="time" value="${event.roscTime}" onchange="updateCpaEventField(${idx}, 'roscTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'roscTime')">Now</button>
          </div>
        </div>
        
        <div id="flow_times_${idx}" style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:10px;border:1px solid #0ea5e9">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-weight:600;color:#0369a1">No Flow Time</span>
            <span id="no_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-weight:600;color:#0369a1">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
        </div>
        
        <label style="margin-top:12px">ãƒ¡ãƒ¢</label>
        <textarea class="memo" placeholder="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx}, 'memo', this.value)">${event.memo}</textarea>
      </div>
    `;
    } else {
      // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
      card.innerHTML = `
      <div class="vital-header">
        <div style="font-weight:600">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}ï¼ˆå†å¿ƒåœæ­¢ï¼‰${event.roscTime ? ' (ROSC)' : ''}</div>
        <button class="vital-del" onclick="deleteCpaEvent(${idx})">å‰Šé™¤</button>
      </div>
      <div style="padding:12px">
        <div class="grid2" style="margin-bottom:12px">
          <div>
            <label>å¿ƒåœæ­¢æ™‚åˆ»</label>
            <div class="time-row">
              <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'arrestTime')">Now</button>
            </div>
          </div>
          <div>
            <label>æ³¢å½¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;text-align:center" onclick="openCpaRhythmDial(${idx})">
              <div class="vital-value" style="font-size:16px">${event.rhythm}</div>
            </div>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸</h3>
        <div id="adrenaline_times_${idx}"></div>
        <button class="btn small" style="margin-top:8px" onclick="addAdrenalineTime(${idx})">ï¼‹ ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³è¿½åŠ </button>
        
        <h3 style="margin-top:12px">è»¢å¸°</h3>
        <div>
          <label>å¿ƒæ‹å†é–‹(ROSC)æ™‚åˆ»</label>
          <div class="time-row">
            <input type="time" value="${event.roscTime}" onchange="updateCpaEventField(${idx}, 'roscTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'roscTime')">Now</button>
          </div>
        </div>
        
        <div id="flow_times_${idx}" style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:10px;border:1px solid #0ea5e9">
          <div style="display:flex;justify-content:space-between">
            <span style="font-weight:600;color:#0369a1">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
        </div>
        
        <label style="margin-top:12px">ãƒ¡ãƒ¢</label>
        <textarea class="memo" placeholder="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx}, 'memo', this.value)">${event.memo}</textarea>
      </div>
    `;
    }
    
    container.appendChild(card);
    renderAdrenalineTimes(idx);
    calcFlowTimes(idx);
  });
}

function updateCpaEventField(idx, field, value) {
  state.fd.cpaEvents[idx][field] = value;
  if(field === 'arrestTime' || field === 'cprStart' || field === 'roscTime') {
    calcFlowTimes(idx);
  }
  updateState();
}

function toggleCpaField(idx, field) {
  state.fd.cpaEvents[idx][field] = !state.fd.cpaEvents[idx][field];
  renderCpaEvents();
  updateState();
}

function setCpaEventNow(idx, field) {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  state.fd.cpaEvents[idx][field] = time;
  renderCpaEvents();
  updateState();
}

function openCpaRhythmDial(idx) {
  const rhythms = ['Asystole', 'PEA', 'VF', 'pulseless VT'];
  const current = state.fd.cpaEvents[idx].rhythm;
  const options = rhythms.map(r => ({label: r, value: r}));
  const wheels = [{options, selected: current}];
  
  openDial('åˆæœŸæ³¢å½¢', wheels, vals => {
    state.fd.cpaEvents[idx].rhythm = vals[0];
    renderCpaEvents();
    updateState();
  });
}

function toggleCpaIntubation(idx) {
  const checked = event.target.checked;
  state.fd.cpaEvents[idx].intubation = checked;
  $(`#cpa_intubation_time_area_${idx}`).style.display = checked ? 'block' : 'none';
  updateState();
}

function toggleCpaPericardio(idx) {
  const checked = event.target.checked;
  state.fd.cpaEvents[idx].pericardio = checked;
  $(`#cpa_pericardio_time_area_${idx}`).style.display = checked ? 'block' : 'none';
  updateState();
}

function addAdrenalineTime(idx) {
  if(!state.fd.cpaEvents[idx].adrenalineTimes) state.fd.cpaEvents[idx].adrenalineTimes = [];
  
  let newTime;
  if(state.fd.cpaEvents[idx].adrenalineTimes.length === 0) {
    const now = new Date();
    newTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  } else {
    const lastTime = state.fd.cpaEvents[idx].adrenalineTimes[state.fd.cpaEvents[idx].adrenalineTimes.length - 1];
    newTime = addMinutesToTime(lastTime, 4);
  }
  
  state.fd.cpaEvents[idx].adrenalineTimes.push(newTime);
  renderAdrenalineTimes(idx);
  updateState();
}

function addMinutesToTime(timeStr, minutes) {
  const [h, m] = timeStr.split(':').map(Number);
  const totalMinutes = h * 60 + m + minutes;
  const newH = Math.floor(totalMinutes / 60) % 24;
  const newM = totalMinutes % 60;
  return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
}

function removeAdrenalineTime(idx, adrIdx) {
  state.fd.cpaEvents[idx].adrenalineTimes.splice(adrIdx, 1);
  renderAdrenalineTimes(idx);
  updateState();
}

function renderAdrenalineTimes(idx) {
  const container = $(`#adrenaline_times_${idx}`);
  if(!container) return;
  container.innerHTML = '';
  
  const times = state.fd.cpaEvents[idx].adrenalineTimes || [];
  times.forEach((time, adrIdx) => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:8px';
    row.innerHTML = `
      <span style="font-weight:500;min-width:60px">${adrIdx + 1}å›ç›®</span>
      <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer;flex:1;text-align:center" onclick="openAdrenalineTimeDial(${idx}, ${adrIdx})">
        <span style="font-size:18px;font-weight:600;color:var(--brand)">${time}</span>
      </div>
      <button class="btn small ghost" style="padding:8px 12px;width:auto" onclick="removeAdrenalineTime(${idx}, ${adrIdx})">å‰Šé™¤</button>
    `;
    container.appendChild(row);
  });
}

function openAdrenalineTimeDial(idx, adrIdx) {
  const currentTime = state.fd.cpaEvents[idx].adrenalineTimes[adrIdx] || '00:00';
  const [h, m] = currentTime.split(':').map(Number);
  
  const hours = [];
  for(let i = 0; i < 24; i++) hours.push({label: String(i).padStart(2,'0'), value: i});
  const minutes = [];
  for(let i = 0; i < 60; i++) minutes.push({label: String(i).padStart(2,'0'), value: i});
  
  const wheels = [
    {options: hours, selected: h, unit: ':'},
    {options: minutes, selected: m, unit: ''}
  ];
  
  openDial(`ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³ ${adrIdx + 1}å›ç›®`, wheels, vals => {
    const newTime = `${String(vals[0]).padStart(2,'0')}:${String(vals[1]).padStart(2,'0')}`;
    state.fd.cpaEvents[idx].adrenalineTimes[adrIdx] = newTime;
    renderAdrenalineTimes(idx);
    updateState();
  });
}

// Flow Timeè¨ˆç®—
function calcFlowTimes(idx) {
  const event = state.fd.cpaEvents[idx];
  const arrestTime = event.arrestTime;
  const cprStart = event.cprStart;
  const roscTime = event.roscTime;
  
  // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›ï¼‰ã®å ´åˆã®ã¿No Flow Timeã‚’è¨ˆç®—
  if(idx === 0) {
    // No Flow Time = å¿ƒåœæ­¢ã‹ã‚‰èƒ¸éª¨åœ§è¿«é–‹å§‹ã¾ã§
    if(arrestTime && cprStart) {
      const noFlow = calcTimeDiffMinutes(arrestTime, cprStart);
      const el = $(`#no_flow_time_${idx}`);
      if(el) el.textContent = noFlow >= 0 ? `${noFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#no_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
    
    // Low Flow Time = èƒ¸éª¨åœ§è¿«é–‹å§‹ã‹ã‚‰ROSCã¾ã§
    if(cprStart && roscTime) {
      const lowFlow = calcTimeDiffMinutes(cprStart, roscTime);
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = lowFlow >= 0 ? `${lowFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
  } else {
    // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆã¯Low Flow Timeã®ã¿ = å¿ƒåœæ­¢ã‹ã‚‰ROSCã¾ã§
    if(arrestTime && roscTime) {
      const lowFlow = calcTimeDiffMinutes(arrestTime, roscTime);
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = lowFlow >= 0 ? `${lowFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
  }
}

function calcTimeDiffMinutes(startTime, endTime) {
  const [sh, sm] = startTime.split(':').map(Number);
  const [eh, em] = endTime.split(':').map(Number);
  const startMinutes = sh * 60 + sm;
  const endMinutes = eh * 60 + em;
  return endMinutes - startMinutes;
}

// ç³å­”å¾„ãƒ€ã‚¤ãƒ¤ãƒ«
function openPupilDial(side) {
  const current = state.fd.stroke?.[`pupil${side}`] || 3;
  const options = [];
  for(let i = 1; i <= 9; i += 0.5) {
    options.push({label: i.toString(), value: i});
  }
  const wheels = [{options, selected: current, unit: 'mm'}];
  
  openDial(`ç³å­”å¾„ ${side === 'L' ? 'å·¦' : 'å³'}`, wheels, vals => {
    if(!state.fd.stroke) state.fd.stroke = {};
    state.fd.stroke[`pupil${side}`] = vals[0];
    $(`#pupil${side}_display`).textContent = vals[0];
    updateState();
  });
}

// MMTãƒ€ã‚¤ãƒ¤ãƒ«
function openMmtDial(limb) {
  const labels = {ru:'å³ä¸Šè‚¢', lu:'å·¦ä¸Šè‚¢', rl:'å³ä¸‹è‚¢', ll:'å·¦ä¸‹è‚¢'};
  const current = state.fd.stroke?.mmt?.[limb] ?? 5;
  const options = [];
  for(let i = 0; i <= 5; i++) {
    options.push({label: i.toString(), value: i});
  }
  const wheels = [{options, selected: current}];
  
  openDial(`MMT ${labels[limb]}`, wheels, vals => {
    if(!state.fd.stroke) state.fd.stroke = {mmt:{}};
    if(!state.fd.stroke.mmt) state.fd.stroke.mmt = {};
    state.fd.stroke.mmt[limb] = vals[0];
    $(`#mmt_${limb}_display`).textContent = vals[0];
    updateState();
  });
}

// NIHSSé …ç›®å®šç¾©
const NIHSS_ITEMS = [
  {id:'1a', label:'1a æ„è­˜æ°´æº–', hint:'0:è¦šé†’ 1:è»½åº¦éˆéº» 2:å¼·ã„åˆºæ¿€ã§é–‹çœ¼ 3:åå¿œãªã—', max:3},
  {id:'1b', label:'1b è³ªå•ï¼ˆå¹´é½¢/æœˆï¼‰', hint:'0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max:2},
  {id:'1c', label:'1c å¾“å‘½ï¼ˆé–‹é–‰çœ¼/æ¡æ‰‹ï¼‰', hint:'0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max:2},
  {id:'2', label:'2 æ³¨è¦–', hint:'0:æ­£å¸¸ 1:éƒ¨åˆ†çš„æ³¨è¦–éº»ç—º 2:å®Œå…¨æ³¨è¦–éº»ç—º', max:2},
  {id:'3', label:'3 è¦–é‡', hint:'0:æ­£å¸¸ 1:éƒ¨åˆ†çš„åŠç›² 2:å®Œå…¨åŠç›² 3:ä¸¡å´æ€§', max:3},
  {id:'4', label:'4 é¡”é¢éº»ç—º', hint:'0:ãªã— 1:è»½åº¦ 2:éƒ¨åˆ†çš„ 3:å®Œå…¨', max:3},
  {id:'5a', label:'5a ä¸Šè‚¢é‹å‹• å³', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'5b', label:'5b ä¸Šè‚¢é‹å‹• å·¦', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'6a', label:'6a ä¸‹è‚¢é‹å‹• å³', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'6b', label:'6b ä¸‹è‚¢é‹å‹• å·¦', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'7', label:'7 é‹å‹•å¤±èª¿', hint:'0:ãªã— 1:1è‚¢ 2:2è‚¢', max:2},
  {id:'8', label:'8 æ„Ÿè¦š', hint:'0:æ­£å¸¸ 1:è»½åº¦ä½ä¸‹ 2:é‡åº¦ä½ä¸‹', max:2},
  {id:'9', label:'9 è¨€èª', hint:'0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦ 3:å…¨å¤±èª', max:3},
  {id:'10', label:'10 æ§‹éŸ³éšœå®³', hint:'0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦', max:2},
  {id:'11', label:'11 æ¶ˆå»/æ³¨æ„éšœå®³', hint:'0:ãªã— 1:è»½åº¦ 2:é‡åº¦', max:2}
];

// NIHSS UIç”Ÿæˆ
function renderNihss() {
  const container = $('#nihss_area');
  if(!container) return;
  container.innerHTML = '';
  
  NIHSS_ITEMS.forEach(item => {
    const row = document.createElement('div');
    row.style.cssText = 'margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e5e7eb';
    
    const val = state.fd.stroke?.nihss?.[item.id] ?? 0;
    
    row.innerHTML = `
      <div style="font-weight:600;font-size:13px">${item.label}</div>
      <div style="font-size:11px;color:#6b7280;margin:2px 0 6px">${item.hint}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${Array.from({length: item.max + 1}, (_, i) => 
          `<button class="nihss-btn ${val === i ? 'active' : ''}" data-item="${item.id}" data-val="${i}" onclick="setNihss('${item.id}',${i})">${i}</button>`
        ).join('')}
      </div>
    `;
    container.appendChild(row);
  });
  
  calcNihssSum();
}

function setNihss(itemId, val) {
  if(!state.fd.stroke) state.fd.stroke = {nihss:{}};
  if(!state.fd.stroke.nihss) state.fd.stroke.nihss = {};
  state.fd.stroke.nihss[itemId] = val;
  
  // ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹æ›´æ–°
  $$(`[data-item="${itemId}"]`).forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.val) === val);
  });
  
  calcNihssSum();
  updateState();
}

function calcNihssSum() {
  const nihss = state.fd.stroke?.nihss || {};
  let sum = 0;
  NIHSS_ITEMS.forEach(item => {
    sum += nihss[item.id] || 0;
  });
  const el = $('#nihss_sum');
  if(el) el.textContent = `${sum}ç‚¹`;
  return sum;
}

// ãƒã‚¤ã‚¿ãƒ«è¿½åŠ ãƒ»æç”»
function addEmsVital() {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  // å‰ã®ãƒã‚¤ã‚¿ãƒ«ãŒã‚ã‚Œã°ãã®å€¤ã‚’å¼•ãç¶™ã
  let newVital;
  if(state.ems.vitals.length > 0) {
    const prev = state.ems.vitals[state.ems.vitals.length - 1];
    newVital = {
      time,
      sbp: prev.sbp,
      dbp: prev.dbp,
      hr: prev.hr,
      rr: prev.rr,
      spo2: prev.spo2,
      bt: prev.bt,
      gcs: {e: prev.gcs.e, v: prev.gcs.v, m: prev.gcs.m},
      jcs: prev.jcs
    };
  } else {
    newVital = {time, sbp:120, dbp:80, hr:80, rr:16, spo2:98, bt:36.5, gcs:{e:4,v:5,m:6}, jcs:'0'};
  }
  
  state.ems.vitals.push(newVital);
  renderEmsVitals();
  updateState();
}

function addFdVital() {
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  // å‰ã®ãƒã‚¤ã‚¿ãƒ«ãŒã‚ã‚Œã°ãã®å€¤ã‚’å¼•ãç¶™ã
  let newVital;
  if(state.fd.vitals.length > 0) {
    const prev = state.fd.vitals[state.fd.vitals.length - 1];
    newVital = {
      time,
      sbp: prev.sbp,
      dbp: prev.dbp,
      hr: prev.hr,
      rr: prev.rr,
      spo2: prev.spo2,
      bt: prev.bt,
      gcs: {e: prev.gcs.e, v: prev.gcs.v, m: prev.gcs.m},
      jcs: prev.jcs
    };
  } else {
    newVital = {time, sbp:120, dbp:80, hr:80, rr:16, spo2:98, bt:36.5, gcs:{e:4,v:5,m:6}, jcs:'0'};
  }
  
  state.fd.vitals.push(newVital);
  renderFdVitals();
  updateState();
}

function removeVital(type, idx) {
  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    state[type].vitals.splice(idx, 1);
    if(type === 'ems') renderEmsVitals();
    else renderFdVitals();
    updateState();
  }
}

function renderEmsVitals() {
  const c = $('#ems_vitals_container');
  c.innerHTML = '';
  state.ems.vitals.forEach((v, i) => c.appendChild(createVitalCard('ems', i, v)));
}

function renderFdVitals() {
  const c = $('#fd_vitals_container');
  c.innerHTML = '';
  state.fd.vitals.forEach((v, i) => c.appendChild(createVitalCard('fd', i, v)));
}

function createVitalCard(type, idx, v) {
  const card = document.createElement('div');
  card.className = 'vital-card';
  
  const gcsSum = v.gcs.v === 'T' ? `${v.gcs.e + v.gcs.m}T` : (v.gcs.e + parseInt(v.gcs.v) + v.gcs.m);
  const spo2Display = v.spo2 === 0 ? '--' : v.spo2;
  
  card.innerHTML = `
    <div class="vital-header">
      <div class="vital-time">
        <input type="time" value="${v.time}" onchange="state.${type}.vitals[${idx}].time=this.value;updateState()">
      </div>
      <button class="vital-del" onclick="removeVital('${type}',${idx})">å‰Šé™¤</button>
    </div>
    <div class="vital-grid">
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'bp')">
        <div class="vital-label">BP</div>
        <div class="vital-value">${v.sbp}/${v.dbp}</div>
        <div class="vital-unit">mmHg</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'hr')">
        <div class="vital-label">HR</div>
        <div class="vital-value">${v.hr}</div>
        <div class="vital-unit">bpm</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'rr')">
        <div class="vital-label">RR</div>
        <div class="vital-value">${v.rr}</div>
        <div class="vital-unit">/min</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'spo2')">
        <div class="vital-label">SpOâ‚‚</div>
        <div class="vital-value">${spo2Display}</div>
        <div class="vital-unit">%</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'bt')">
        <div class="vital-label">BT</div>
        <div class="vital-value">${v.bt}</div>
        <div class="vital-unit">â„ƒ</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'jcs')">
        <div class="vital-label">JCS</div>
        <div class="vital-value">${v.jcs}</div>
      </div>
      <div class="vital-gcs">
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_e')">
          <span class="lbl">E</span>
          <span class="val">${v.gcs.e}</span>
        </div>
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_v')">
          <span class="lbl">V</span>
          <span class="val">${v.gcs.v}</span>
        </div>
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_m')">
          <span class="lbl">M</span>
          <span class="val">${v.gcs.m}</span>
        </div>
        <div class="gcs-sum">${gcsSum}</div>
      </div>
    </div>
  `;
  return card;
}

// æ™‚åˆ»è¨­å®š
function setNow(id) {
  const now = new Date();
  $(`#${id}`).value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  updateState();
}

// ãƒãƒƒãƒ—
function mkChip(label, mode, prefix) {
  const el = document.createElement('span');
  el.className = 'chip';
  el.textContent = label;
  el.dataset.state = state[prefix].chips[label] || '';
  
  el.onclick = () => {
    const cur = el.dataset.state || '';
    let nxt = '';
    if(mode === 'normal') nxt = cur === 'on' ? '' : 'on';
    else nxt = cur === '' ? '+' : cur === '+' ? '-' : '';
    el.dataset.state = nxt;
    if(nxt) state[prefix].chips[label] = nxt;
    else delete state[prefix].chips[label];
    updateState();
  };
  return el;
}

function mountChips(id, def, prefix) {
  const box = $(id);
  if(!box) return;
  box.innerHTML = '';
  if(Array.isArray(def)) {
    def.forEach(x => box.appendChild(mkChip(x, 'abn', prefix)));
  } else {
    (def.normal || []).forEach(x => box.appendChild(mkChip(x, 'normal', prefix)));
    (def.abn || []).forEach(x => box.appendChild(mkChip(x, 'abn', prefix)));
  }
}

// å‡¦ç½®ãƒ»è–¬å‰¤ãƒãƒƒãƒ—
function renderProcedureChips(containerId, items, stateObj) {
  const c = $(`#${containerId}`);
  c.innerHTML = '';
  items.forEach(item => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = item;
    if(stateObj[item]) chip.dataset.state = 'proc';
    chip.onclick = () => {
      stateObj[item] = !stateObj[item];
      chip.dataset.state = stateObj[item] ? 'proc' : '';
      if(containerId === 'ems_procedures' && item === 'é…¸ç´ æŠ•ä¸') {
        $('#ems_o2_amount').style.display = stateObj[item] ? 'block' : 'none';
      }
      updateState();
    };
    c.appendChild(chip);
  });
}

// ã‚¿ãƒ–
function setupExamTabs(prefix) {
  $$(`#${prefix}_examTabs .exam-tab`).forEach(tab => {
    tab.onclick = () => {
      $$(`#${prefix}_examTabs .exam-tab`).forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const examType = tab.dataset.exam;
      state[prefix].exam_tab = examType;
      const card = tab.closest('.card');
      card.querySelectorAll('.exam-pane').forEach(p => p.classList.remove('active'));
      card.querySelector(`.exam-pane[data-pane="${examType}"]`)?.classList.add('active');
      
      // CPAã‚¿ãƒ–é¸æŠæ™‚ã«ãƒã‚¤ã‚¿ãƒ«åˆæœŸå€¤ã‚’CPAç”¨ã«å¤‰æ›´
      if(examType === 'cpa') {
        setCpaVitalDefaults();
        // å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆãŒç©ºã®å ´åˆã¯è‡ªå‹•çš„ã«è¿½åŠ 
        if(prefix === 'fd' && state.fd.cpaEvents.length === 0) {
          addCpaEvent();
        }
      }
      
      updateState();
    };
  });
}

// CPAç”¨ãƒã‚¤ã‚¿ãƒ«åˆæœŸå€¤è¨­å®š
function setCpaVitalDefaults() {
  console.log('setCpaVitalDefaults called');
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  if(!confirm('CPAãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\nãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’CPAåˆæœŸå€¤ï¼ˆBP:0, HR:0, RR:0, SpO2:æ¸¬å®šä¸èƒ½, JCS:300, GCS:E1V1M1ï¼‰ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) {
    console.log('User cancelled CPA vital defaults');
    return;
  }
  
  console.log('Setting CPA vital defaults');
  
  // æ•‘æ€¥éšŠãƒã‚¤ã‚¿ãƒ«
  state.ems.vitals.forEach(v => {
    v.sbp = 0;
    v.dbp = 0;
    v.hr = 0;
    v.rr = 0;
    v.spo2 = 0; // æ¸¬å®šä¸èƒ½
    v.jcs = '300';
    v.gcs = {e: 1, v: 1, m: 1};
  });
  
  // FDãƒã‚¤ã‚¿ãƒ«
  state.fd.vitals.forEach(v => {
    v.sbp = 0;
    v.dbp = 0;
    v.hr = 0;
    v.rr = 0;
    v.spo2 = 0; // æ¸¬å®šä¸èƒ½
    v.jcs = '300';
    v.gcs = {e: 1, v: 1, m: 1};
  });
  
  console.log('Rendering vitals');
  renderEmsVitals();
  renderFdVitals();
  updateState();
  console.log('CPA vital defaults complete');
}

// ãƒ¡ãƒ¢ãƒã‚¤ãƒ³ãƒ‰
function bindMemos() {
  const bind = (id, obj, key) => {
    const el = $(id);
    if(el) {
      el.value = obj[key] || '';
      el.oninput = () => { obj[key] = el.value; updateState(); };
    }
  };
  ['head','resp','card','abd','limb','neuro'].forEach(k => bind(`#memo-ems-gen-${k}`, state.ems.memos.general, k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k => bind(`#memo-ems-tra-${k}`, state.ems.memos.trauma, k));
  // EMS CPAãƒ¡ãƒ¢
  if(!state.ems.memos.cpa) state.ems.memos.cpa = {memo:''};
  bind('#memo-ems-cpa', state.ems.memos.cpa, 'memo');
  // EMSè„³å’ä¸­ãƒ¡ãƒ¢
  if(!state.ems.memos.stroke) state.ems.memos.stroke = {memo:''};
  bind('#memo-ems-str', state.ems.memos.stroke, 'memo');
  ['head','resp','card','abd','limb','neuro'].forEach(k => bind(`#memo-fd-gen-${k}`, state.fd.memos.general, k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k => bind(`#memo-fd-tra-${k}`, state.fd.memos.trauma, k));
  ['neuro','motor','eye','higher'].forEach(k => bind(`#memo-fd-str-${k}`, state.fd.memos.stroke, k));
  // è„³å’ä¸­è©³ç´°ãƒ¡ãƒ¢
  ['cn','eye','motor','reflex','higher'].forEach(k => {
    const el = $(`#memo-fd-str-${k}`);
    if(el) {
      if(!state.fd.memos.stroke) state.fd.memos.stroke = {};
      el.value = state.fd.memos.stroke[k] || '';
      el.oninput = () => { state.fd.memos.stroke[k] = el.value; updateState(); };
    }
  });
  ['body','head','trunk'].forEach(k => bind(`#memo-fd-cpa-${k}`, state.fd.memos.cpa, k));
}

// è¡€ã‚¬ã‚¹
const ABG_ITEMS = [{item:'pH',unit:'',normal:'7.40'},{item:'pCO2',unit:'mmHg',normal:'40'},{item:'pO2',unit:'mmHg',normal:'95'},{item:'HCO3-',unit:'mmol/L',normal:'24'},{item:'BE',unit:'mEq/L',normal:'0'},{item:'Lac',unit:'mmol/L',normal:'1.0'},{item:'Na',unit:'mEq/L',normal:'140'},{item:'Cr',unit:'mg/dL',normal:'0.8'}];

// è¡€ã‚¬ã‚¹é …ç›®ã”ã¨ã®ãƒ€ã‚¤ãƒ¤ãƒ«è¨­å®š
const ABG_DIAL_CONFIG = {
  'pH': {min: 6.80, max: 7.80, step: 0.01, decimals: 2},
  'pCO2': {min: 10, max: 150, step: 1, decimals: 0},
  'pO2': {min: 10, max: 500, step: 1, decimals: 0},
  'HCO3-': {min: 0, max: 50, step: 1, decimals: 0},
  'BE': {min: -30, max: 30, step: 1, decimals: 0},
  'Lac': {min: 0, max: 30, step: 0.1, decimals: 1},
  'Na': {min: 100, max: 180, step: 1, decimals: 0},
  'Cr': {min: 0.1, max: 15, step: 0.1, decimals: 1}
};

function toggleAbg() {
  state.fd.abg_type = $('#fd_abg_type').value;
  $('#abg_area').style.display = state.fd.abg_type ? 'block' : 'none';
  updateState();
}

function addAbgSet() {
  ABG_ITEMS.forEach(item => {
    if(!state.fd.abg_data.some(x => x.item === item.item)) {
      state.fd.abg_data.push({item: item.item, unit: item.unit, val: item.normal});
    }
  });
  renderAbgPills();
  updateState();
}

function clearAbg() {
  if(confirm('ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
    state.fd.abg_data = [];
    renderAbgPills();
    updateState();
  }
}

function openAbgDial(index) {
  const rec = state.fd.abg_data[index];
  const config = ABG_DIAL_CONFIG[rec.item];
  if(!config) return;
  
  const options = [];
  for(let v = config.min; v <= config.max; v += config.step) {
    const val = v.toFixed(config.decimals);
    options.push({label: val, value: val});
  }
  
  const currentVal = parseFloat(rec.val) || config.min;
  const wheels = [{
    options: options,
    selected: currentVal.toFixed(config.decimals),
    unit: rec.unit
  }];
  
  openDial(`${rec.item}`, wheels, vals => {
    rec.val = vals[0];
    renderAbgPills();
    updateState();
  });
}

// é•·æŠ¼ã—ã§æ‰‹å…¥åŠ›
function openAbgManualInput(index) {
  const rec = state.fd.abg_data[index];
  const newVal = prompt(`${rec.item} ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, rec.val);
  if(newVal !== null && newVal.trim() !== '') {
    rec.val = newVal.trim();
    renderAbgPills();
    updateState();
  }
}

function renderAbgPills() {
  const c = $('#abg_pills');
  c.innerHTML = '';
  state.fd.abg_data.forEach((rec, i) => {
    const pill = document.createElement('div');
    pill.className = 'labpill';
    pill.style.cursor = 'pointer';
    pill.innerHTML = `
      <label>${rec.item}</label>
      <span class="abg-val" style="min-width:50px;text-align:right;font-weight:600;color:var(--brand)">${rec.val}</span>
      <span class="unit">${rec.unit}</span>
      <button onclick="event.stopPropagation();state.fd.abg_data.splice(${i},1);renderAbgPills();updateState()">Ã—</button>
    `;
    
    // ã‚¿ãƒƒãƒ—ã§ãƒ€ã‚¤ãƒ¤ãƒ«ã€é•·æŠ¼ã—ã§æ‰‹å…¥åŠ›
    let pressTimer = null;
    let isLongPress = false;
    
    const valSpan = pill.querySelector('.abg-val');
    
    valSpan.addEventListener('touchstart', e => {
      isLongPress = false;
      pressTimer = setTimeout(() => {
        isLongPress = true;
        openAbgManualInput(i);
      }, 500);
    });
    
    valSpan.addEventListener('touchend', e => {
      clearTimeout(pressTimer);
      if(!isLongPress) {
        openAbgDial(i);
      }
    });
    
    valSpan.addEventListener('touchmove', () => {
      clearTimeout(pressTimer);
    });
    
    // ãƒã‚¦ã‚¹æ“ä½œå¯¾å¿œ
    valSpan.addEventListener('mousedown', e => {
      isLongPress = false;
      pressTimer = setTimeout(() => {
        isLongPress = true;
        openAbgManualInput(i);
      }, 500);
    });
    
    valSpan.addEventListener('mouseup', e => {
      clearTimeout(pressTimer);
      if(!isLongPress) {
        openAbgDial(i);
      }
    });
    
    valSpan.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });
    
    c.appendChild(pill);
  });
}

function toggleExam(type) {
  state.fd.exams[type] = $(`#exam_${type}`).checked;
  if(type === 'bs') {
    $('#exam_bs_area').style.display = state.fd.exams[type] ? 'block' : 'none';
  } else {
    $(`#exam_${type}_txt`).style.display = state.fd.exams[type] ? 'block' : 'none';
  }
  updateState();
}

// ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ 
function addProblem() {
  const input = $('#new_problem');
  const text = input.value.trim();
  if(text) {
    state.problems.push(text);
    input.value = '';
    renderProblems();
    updateState();
  }
}

function renderProblems() {
  const c = $('#problems');
  c.innerHTML = state.problems.map((p, i) => `
    <div class="problem-item">
      <span>#${i+1} ${p}</span>
      <button class="del-btn" onclick="state.problems.splice(${i},1);renderProblems();updateState()">å‰Šé™¤</button>
    </div>
  `).join('');
}

// ç—…é™¢é¸æŠï¼ˆåœ°åŸŸåˆ¥ï¼‰
let selectedRegion = 'é¹¿å…å³¶';

function renderHospitalChips() {
  const container = $('#destination_chips');
  container.innerHTML = '';
  
  // åœ°åŸŸã‚¿ãƒ–
  const regionTabs = document.createElement('div');
  regionTabs.className = 'region-tabs';
  regionTabs.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--line)';
  
  Object.keys(state.hospitals).forEach(region => {
    const tab = document.createElement('div');
    tab.className = 'region-tab';
    tab.style.cssText = `padding:6px 12px;border-radius:16px;font-size:13px;cursor:pointer;${selectedRegion === region ? 'background:var(--brand);color:#fff' : 'background:var(--chip)'}`;
    tab.textContent = region;
    tab.onclick = () => {
      selectedRegion = region;
      renderHospitalChips();
    };
    regionTabs.appendChild(tab);
  });
  container.appendChild(regionTabs);
  
  // åŒ»ç™‚æ©Ÿé–¢ãƒãƒƒãƒ—
  const hospitalsContainer = document.createElement('div');
  hospitalsContainer.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px';
  
  const hospitals = state.hospitals[selectedRegion] || [];
  hospitals.forEach(h => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.destination.hospital === h ? ' active' : '');
    chip.textContent = h;
    chip.onclick = () => selectHospital(h);
    hospitalsContainer.appendChild(chip);
  });
  container.appendChild(hospitalsContainer);
  
  updateDestinationDisplay();
}

function selectHospital(name) {
  // åŒã˜ç—…é™¢ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é¸æŠè§£é™¤
  if(state.destination.hospital === name) {
    state.destination.hospital = '';
  } else {
    state.destination.hospital = name;
    state.destination.custom = ''; // ç°¡æ˜“é¸æŠæ™‚ã¯è‡ªç”±è¨˜è¼‰ã‚’ã‚¯ãƒªã‚¢
    $('#destination_custom').value = '';
  }
  renderHospitalChips();
  updateState();
}

function updateDestinationDisplay() {
  const display = $('#destination_display');
  const selected = $('#destination_selected');
  const hospital = state.destination.custom || state.destination.hospital;
  if(hospital) {
    display.style.display = 'block';
    selected.textContent = hospital;
  } else {
    display.style.display = 'none';
  }
}

// çŠ¶æ…‹æ›´æ–°
function updateState() {
  state.request.type = $('#request_type').value;
  state.request.detail = $('#request_detail').value;
  state.request.time = $('#request_time').value;
  state.patient.history = $('#patient_history').value;
  state.patient.medication = $('#patient_medication').value;
  state.patient.allergy = $('#patient_allergy').value;
  state.patient.lastMeal = $('#last_meal_time').value;
  state.patient.hospital = $('#patient_hospital').value;
  state.heli.takeoff = $('#heli_takeoff').value;
  state.heli.lz_landing = $('#heli_lz_landing').value;
  state.heli.fd_contact = $('#fd_contact').value;
  state.heli.turn_type = $('#turn_type').value;
  state.heli.transport_takeoff = $('#transport_takeoff').value;
  state.heli.hospital_arrival = $('#hospital_arrival').value;
  state.ems.aware = $('#ems_aware').value;
  state.ems.arrival = $('#ems_arrival').value;
  state.ems.contact = $('#ems_contact').value;
  state.ems.lz = $('#ems_lz').value;
  state.ems.o2_flow = $('#ems_o2_flow').value;
  state.ems.procedures_detail = $('#ems_procedures_detail').value;
  state.ems.stroke_onset = $('#ems_stroke_onset')?.value || '';
  state.fd.bs = $('#fd_bs').value;
  state.fd.exam_detail = $('#fd_exam_detail').value;
  state.fd.procedure_detail = $('#fd_procedure_detail').value;
  state.fd.drug_detail = $('#fd_drug_detail').value;
  ['us','ecg','fast','efast'].forEach(t => { state.fd.exam_texts[t] = $(`#exam_${t}_txt`).value; });
  
  // è„³å’ä¸­æƒ…å ±
  if($('#plrL')) {
    if(!state.fd.stroke) state.fd.stroke = {mmt:{}, nihss:{}};
    state.fd.stroke.plrL = $('#plrL').value;
    state.fd.stroke.plrR = $('#plrR').value;
    state.fd.stroke.gaze = $('#str_gaze').value;
    state.fd.stroke.nyst = $('#str_nyst').value;
    state.fd.stroke.btr = $('#str_btr').value;
    state.fd.stroke.ptr = $('#str_ptr').value;
    state.fd.stroke.babinski = $('#str_babinski').checked;
    state.fd.stroke.chaddock = $('#str_chaddock').checked;
    state.fd.stroke.nihssMemo = $('#nihss_memo')?.value || '';
  }
  
  state.consideration = $('#consideration').value;
  // è‡ªç”±è¨˜è¼‰ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ç°¡æ˜“é¸æŠã‚’ä½¿ç”¨
  const customHospital = $('#destination_custom').value.trim();
  if(customHospital) {
    state.destination.custom = customHospital;
    // è‡ªç”±è¨˜è¼‰å…¥åŠ›æ™‚ã¯ç°¡æ˜“é¸æŠã‚’ã‚¯ãƒªã‚¢
    if(state.destination.hospital) {
      state.destination.hospital = '';
      renderHospitalChips();
    }
  } else {
    state.destination.custom = '';
  }
  state.destination.reason = $('#selection_reason').value;
  updateDestinationDisplay();
  
  render();
  localStorage.setItem('heliRecordV33', JSON.stringify(state));
}

function render() {
  $('#outText').textContent = generateReport();
}

function fmtFinding(lbl, st) {
  if(st === 'on') return lbl;
  if(st === '+') return `${lbl}ï¼ˆï¼‹ï¼‰`;
  if(st === '-') return `${lbl}ï¼ˆâˆ’ï¼‰`;
  return null;
}

function extractFindings(def, chips) {
  const arr = [];
  const labels = Array.isArray(def) ? def : (def.normal || []).concat(def.abn || []);
  labels.forEach(lbl => {
    const st = chips[lbl];
    if(st) { const s = fmtFinding(lbl, st); if(s) arr.push(s); }
  });
  return arr.join('ã€');
}

function generateReport() {
  let r = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ç—…é™¢å‰åŒ»ç™‚æ´»å‹•è¨˜éŒ²\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
  
  r += 'ã€è¦è«‹æƒ…å ±ã€‘\n';
  r += `è¦è«‹æ–¹æ³•ï¼š${state.request.type || 'ï¼ˆæœªé¸æŠï¼‰'}\n`;
  if(state.request.time) r += `è¦è«‹æ™‚åˆ»ï¼š${state.request.time}\n`;
  if(state.request.detail) r += `è¦è«‹å†…å®¹ï¼š${state.request.detail}\n`;
  r += '\n';
  
  // æ‚£è€…æƒ…å ±
  const hasPatientInfo = state.patient?.history || state.patient?.medication || state.patient?.allergy || state.patient?.lastMeal || state.patient?.hospital;
  if(hasPatientInfo) {
    r += 'ã€æ‚£è€…æƒ…å ±ã€‘\n';
    if(state.patient.history) r += `æ—¢å¾€æ­´ï¼š${state.patient.history}\n`;
    if(state.patient.medication) r += `å¸¸ç”¨è–¬ï¼š${state.patient.medication}\n`;
    if(state.patient.allergy) r += `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š${state.patient.allergy}\n`;
    if(state.patient.lastMeal) r += `æœ€çµ‚é£Ÿäº‹ï¼š${state.patient.lastMeal}\n`;
    if(state.patient.hospital) r += `ã‹ã‹ã‚Šã¤ã‘ï¼š${state.patient.hospital}\n`;
    r += '\n';
  }
  
  r += 'ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€‘\n';
  if(state.request.time) r += `è¦è«‹ï¼š${state.request.time}\n`;
  if(state.ems.aware) r += `æ•‘æ€¥éšŠè¦šçŸ¥ï¼š${state.ems.aware}\n`;
  if(state.ems.arrival) r += `æ•‘æ€¥éšŠç¾ç€ï¼š${state.ems.arrival}\n`;
  if(state.ems.contact) r += `æ•‘æ€¥éšŠæ¥è§¦ï¼š${state.ems.contact}\n`;
  if(state.heli.takeoff) r += `ãƒ˜ãƒªé›¢é™¸ï¼š${state.heli.takeoff}\n`;
  if(state.heli.lz_landing) r += `ãƒ˜ãƒªLZç€ï¼š${state.heli.lz_landing}\n`;
  if(state.heli.fd_contact) r += `FDæ¥è§¦ï¼š${state.heli.fd_contact}\n`;
  if(state.ems.lz) r += `æ•‘æ€¥éšŠLZç€ï¼š${state.ems.lz}\n`;
  r += `æ´»å‹•ï¼š${state.heli.turn_type}\n`;
  if(state.heli.turn_type !== 'Iã‚¿ãƒ¼ãƒ³') {
    if(state.heli.transport_takeoff) r += `æ¬é€é›¢é™¸ï¼š${state.heli.transport_takeoff}\n`;
    if(state.heli.hospital_arrival) r += `ç—…é™¢ç€ï¼š${state.heli.hospital_arrival}\n`;
  }
  r += '\n';
  
  r += 'ã€æ•‘æ€¥éšŠæ´»å‹•ã€‘\n';
  if(state.ems.vitals.length > 0) {
    r += 'ï¼œãƒã‚¤ã‚¿ãƒ«ï¼\n';
    state.ems.vitals.forEach(v => {
      const gcs = v.gcs.v === 'T' ? `E${v.gcs.e}VTM${v.gcs.m}(${v.gcs.e+v.gcs.m}T)` : `E${v.gcs.e}V${v.gcs.v}M${v.gcs.m}(${v.gcs.e+parseInt(v.gcs.v)+v.gcs.m})`;
      const spo2 = v.spo2 === 0 ? 'æ¸¬å®šä¸èƒ½' : `${v.spo2}%`;
      r += `[${v.time}] BP:${v.sbp}/${v.dbp} HR:${v.hr} RR:${v.rr} SpOâ‚‚:${spo2} BT:${v.bt}â„ƒ GCS:${gcs} JCS:${v.jcs}\n`;
    });
  }
  
  const tab = state.ems.exam_tab;
  if(tab === 'general') {
    r += '\nï¼œæ‰€è¦‹ï¼\n';
    [['é ­é šéƒ¨',EMS_GEN_GROUPS.head,'head'],['å‘¼å¸å™¨',EMS_GEN_GROUPS.resp,'resp'],['å¾ªç’°å™¨',EMS_GEN_GROUPS.card,'card'],['è…¹éƒ¨',EMS_GEN_GROUPS.abd,'abd'],['å››è‚¢',EMS_GEN_GROUPS.limb,'limb'],['ç¥çµŒ',EMS_GEN_GROUPS.neuro,'neuro']].forEach(([title,def,key]) => {
      const s = extractFindings(def, state.ems.chips);
      const m = state.ems.memos.general[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(tab === 'trauma') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆå¤–å‚·ï¼‰ï¼\n';
    [['é ­éƒ¨ãƒ»é¡”é¢',EMS_TRA_GROUPS.head,'head'],['é ¸éƒ¨',EMS_TRA_GROUPS.neck,'neck'],['èƒ¸éƒ¨',EMS_TRA_GROUPS.chest,'chest'],['è…¹éƒ¨',EMS_TRA_GROUPS.abd,'abd'],['éª¨ç›¤',EMS_TRA_GROUPS.pelvis,'pelvis'],['å››è‚¢',EMS_TRA_GROUPS.limb,'limb']].forEach(([title,arr,key]) => {
      const s = extractFindings(arr, state.ems.chips);
      const m = state.ems.memos.trauma[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(tab === 'cpa') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆCPAï¼‰ï¼\n';
    [['åˆæœŸæ³¢å½¢',EMS_CPA_GROUPS.rhythm],['ç›®æ’ƒ/ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼',EMS_CPA_GROUPS.witness],['æ°—é“',EMS_CPA_GROUPS.airway],['å¾ªç’°',EMS_CPA_GROUPS.circulation],['èƒ¸è…¹éƒ¨',EMS_CPA_GROUPS.chest]].forEach(([title,arr]) => {
      const s = extractFindings(arr, state.ems.chips);
      if(s) r += `ã€${title}ã€‘${s}\n`;
    });
    if(state.ems.memos.cpa?.memo) r += `ãƒ¡ãƒ¢ï¼š${state.ems.memos.cpa.memo}\n`;
  } else if(tab === 'stroke') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆè„³å’ä¸­ï¼‰ï¼\n';
    [['æ„è­˜',EMS_STR_GROUPS.conscious],['é¡”é¢ãƒ»ç™ºèª',EMS_STR_GROUPS.face],['é‹å‹•',EMS_STR_GROUPS.motor],['ãã®ä»–',EMS_STR_GROUPS.other]].forEach(([title,arr]) => {
      const s = extractFindings(arr, state.ems.chips);
      if(s) r += `ã€${title}ã€‘${s}\n`;
    });
    if(state.ems.stroke_onset) r += `ç™ºç—‡æ™‚åˆ»ï¼š${state.ems.stroke_onset}\n`;
    if(state.ems.memos.stroke?.memo) r += `ãƒ¡ãƒ¢ï¼š${state.ems.memos.stroke.memo}\n`;
  }
  
  const emsProc = state.ems.procedures_items.filter(k => state.ems.procedures[k]);
  if(emsProc.length > 0 || state.ems.procedures_detail) {
    r += '\nï¼œå‡¦ç½®ï¼\n';
    if(emsProc.length > 0) r += emsProc.map(p => p === 'é…¸ç´ æŠ•ä¸' && state.ems.o2_flow ? `${p}(${state.ems.o2_flow})` : p).join('ã€') + '\n';
    if(state.ems.procedures_detail) r += state.ems.procedures_detail + '\n';
  }
  r += '\n';
  
  r += 'ã€ãƒ•ãƒ©ã‚¤ãƒˆãƒ‰ã‚¯ã‚¿ãƒ¼æ´»å‹•ã€‘\n';
  if(state.fd.vitals.length > 0) {
    r += 'ï¼œãƒã‚¤ã‚¿ãƒ«ï¼\n';
    state.fd.vitals.forEach(v => {
      const gcs = v.gcs.v === 'T' ? `E${v.gcs.e}VTM${v.gcs.m}(${v.gcs.e+v.gcs.m}T)` : `E${v.gcs.e}V${v.gcs.v}M${v.gcs.m}(${v.gcs.e+parseInt(v.gcs.v)+v.gcs.m})`;
      const spo2 = v.spo2 === 0 ? 'æ¸¬å®šä¸èƒ½' : `${v.spo2}%`;
      r += `[${v.time}] BP:${v.sbp}/${v.dbp} HR:${v.hr} RR:${v.rr} SpOâ‚‚:${spo2} BT:${v.bt}â„ƒ GCS:${gcs} JCS:${v.jcs}\n`;
    });
  }
  
  const fdTab = state.fd.exam_tab;
  if(fdTab === 'general') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼\n';
    [['é ­é šéƒ¨',FD_GEN_GROUPS.head,'head'],['å‘¼å¸å™¨',FD_GEN_GROUPS.resp,'resp'],['å¾ªç’°å™¨',FD_GEN_GROUPS.card,'card'],['è…¹éƒ¨',FD_GEN_GROUPS.abd,'abd'],['å››è‚¢',FD_GEN_GROUPS.limb,'limb'],['ç¥çµŒ',FD_GEN_GROUPS.neuro,'neuro']].forEach(([title,def,key]) => {
      const s = extractFindings(def, state.fd.chips);
      const m = state.fd.memos.general[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(fdTab === 'trauma') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼ˆå¤–å‚·ï¼‰ï¼\n';
    [['é ­éƒ¨ãƒ»é¡”é¢',FD_TRA_GROUPS.head,'head'],['é ¸éƒ¨',FD_TRA_GROUPS.neck,'neck'],['èƒ¸éƒ¨',FD_TRA_GROUPS.chest,'chest'],['è…¹éƒ¨',FD_TRA_GROUPS.abd,'abd'],['éª¨ç›¤',FD_TRA_GROUPS.pelvis,'pelvis'],['å››è‚¢',FD_TRA_GROUPS.limb,'limb']].forEach(([title,arr,key]) => {
      const s = extractFindings(arr, state.fd.chips);
      const m = state.fd.memos.trauma[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(fdTab === 'stroke') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼ˆè„³å’ä¸­ï¼‰ï¼\n';
    
    // è„³ç¥çµŒæ‰€è¦‹ãƒãƒƒãƒ—
    const cnFindings = extractFindings(FD_STR_GROUPS.cn, state.fd.chips);
    const cnMemo = state.fd.memos?.stroke?.cn || '';
    if(cnFindings || cnMemo) r += `ã€è„³ç¥çµŒã€‘${[cnFindings, cnMemo].filter(Boolean).join('ã€‚')}\n`;
    
    // ç³å­”ãƒ»çœ¼çƒ
    const str = state.fd.stroke || {};
    let eyeFindings = [];
    if(str.pupilL || str.pupilR) eyeFindings.push(`ç³å­”å¾„ L:${str.pupilL || '-'}mm R:${str.pupilR || '-'}mm`);
    if(str.plrL || str.plrR) eyeFindings.push(`å¯¾å…‰åå°„ L:${str.plrL || '-'} R:${str.plrR || '-'}`);
    if(str.gaze) eyeFindings.push(`å…±åŒåè¦–:${str.gaze}`);
    if(str.nyst) eyeFindings.push(`çœ¼æŒ¯:${str.nyst}`);
    if(eyeFindings.length > 0) r += `ã€ç³å­”ãƒ»çœ¼ã€‘${eyeFindings.join('ã€')}\n`;
    
    // MMT
    if(str.mmt) {
      r += `ã€é‹å‹•MMTã€‘å³ä¸Šè‚¢:${str.mmt.ru ?? 5} å·¦ä¸Šè‚¢:${str.mmt.lu ?? 5} å³ä¸‹è‚¢:${str.mmt.rl ?? 5} å·¦ä¸‹è‚¢:${str.mmt.ll ?? 5}\n`;
    }
    
    // åå°„
    let reflexFindings = [];
    if(str.btr) reflexFindings.push(`BTR:${str.btr}`);
    if(str.ptr) reflexFindings.push(`PTR:${str.ptr}`);
    if(str.babinski) reflexFindings.push('Babinskié™½æ€§');
    if(str.chaddock) reflexFindings.push('Chaddocké™½æ€§');
    if(reflexFindings.length > 0) r += `ã€åå°„ã€‘${reflexFindings.join('ã€')}\n`;
    
    // é«˜æ¬¡è„³æ©Ÿèƒ½
    const higherFindings = extractFindings(FD_STR_GROUPS.higher, state.fd.chips);
    const higherMemo = state.fd.memos?.stroke?.higher || '';
    if(higherFindings || higherMemo) r += `ã€é«˜æ¬¡è„³æ©Ÿèƒ½ã€‘${[higherFindings, higherMemo].filter(Boolean).join('ã€‚')}\n`;
    
    // NIHSS
    if(str.nihss && Object.keys(str.nihss).length > 0) {
      let nihssSum = 0;
      NIHSS_ITEMS.forEach(item => nihssSum += str.nihss[item.id] || 0);
      r += `ã€NIHSSã€‘${nihssSum}ç‚¹\n`;
      if(str.nihssMemo) r += `NIHSSãƒ¡ãƒ¢ï¼š${str.nihssMemo}\n`;
    }
  } else if(fdTab === 'cpa') {
    r += '\nï¼œCPAè¨˜éŒ²ï¼\n';
    if(state.fd.cpaEvents && state.fd.cpaEvents.length > 0) {
      state.fd.cpaEvents.forEach((cpa, idx) => {
        if(state.fd.cpaEvents.length > 1) r += `\nã€å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}${idx > 0 ? 'ï¼ˆå†å¿ƒåœæ­¢ï¼‰' : ''}ã€‘\n`;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›ï¼‰ã®å ´åˆ
        if(idx === 0) {
          if(cpa.arrestTime) r += `å¿ƒåœæ­¢æ™‚åˆ»ï¼š${cpa.arrestTime}\n`;
          if(cpa.rhythm) r += `åˆæœŸæ³¢å½¢ï¼š${cpa.rhythm}\n`;
          r += `ç›®æ’ƒï¼š${cpa.witnessed ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
          r += `ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRï¼š${cpa.bystander ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
          if(cpa.cprStart) r += `èƒ¸éª¨åœ§è¿«é–‹å§‹ï¼š${cpa.cprStart}\n`;
          if(cpa.ivTime) r += `æœ«æ¢¢ç¢ºä¿ï¼š${cpa.ivTime}\n`;
          if(cpa.adrenalineTimes && cpa.adrenalineTimes.length > 0) {
            r += `ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸ï¼š${cpa.adrenalineTimes.map((t,i) => `${i+1}å›ç›® ${t}`).join('ã€')}\n`;
          }
          if(cpa.lt) r += `LTæŒ¿å…¥ï¼šå®Ÿæ–½\n`;
          if(cpa.intubation) r += `æ°—ç®¡æŒ¿ç®¡ï¼š${cpa.intubationTime || 'å®Ÿæ–½'}\n`;
          if(cpa.pericardio) r += `å¿ƒè†œè…”ç©¿åˆºï¼š${cpa.pericardioTime || 'å®Ÿæ–½'}\n`;
          if(cpa.roscTime) r += `å¿ƒæ‹å†é–‹(ROSC)ï¼š${cpa.roscTime}\n`;
          
          // Flow Timeè¨ˆç®—
          if(cpa.arrestTime && cpa.cprStart) {
            const noFlow = calcTimeDiffMinutes(cpa.arrestTime, cpa.cprStart);
            if(noFlow >= 0) r += `No Flow Timeï¼š${noFlow}åˆ†\n`;
          }
          if(cpa.cprStart && cpa.roscTime) {
            const lowFlow = calcTimeDiffMinutes(cpa.cprStart, cpa.roscTime);
            if(lowFlow >= 0) r += `Low Flow Timeï¼š${lowFlow}åˆ†\n`;
          }
        } else {
          // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
          if(cpa.arrestTime) r += `å¿ƒåœæ­¢æ™‚åˆ»ï¼š${cpa.arrestTime}\n`;
          if(cpa.rhythm) r += `æ³¢å½¢ï¼š${cpa.rhythm}\n`;
          if(cpa.adrenalineTimes && cpa.adrenalineTimes.length > 0) {
            r += `ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸ï¼š${cpa.adrenalineTimes.map((t,i) => `${i+1}å›ç›® ${t}`).join('ã€')}\n`;
          }
          if(cpa.roscTime) r += `å¿ƒæ‹å†é–‹(ROSC)ï¼š${cpa.roscTime}\n`;
          
          // Low Flow Time = å¿ƒåœæ­¢ã‹ã‚‰ROSCã¾ã§
          if(cpa.arrestTime && cpa.roscTime) {
            const lowFlow = calcTimeDiffMinutes(cpa.arrestTime, cpa.roscTime);
            if(lowFlow >= 0) r += `Low Flow Timeï¼š${lowFlow}åˆ†\n`;
          }
        }
        
        if(cpa.memo) r += `ãƒ¡ãƒ¢ï¼š${cpa.memo}\n`;
      });
    } else {
      r += 'ãƒ‡ãƒ¼ã‚¿ãªã—\n';
    }
  }
  
  if((state.fd.exams?.bs && state.fd.bs) || state.fd.abg_type || Object.values(state.fd.exams).some(v=>v) || state.fd.exam_detail) {
    r += '\nï¼œæ¤œæŸ»ï¼\n';
    if(state.fd.exams?.bs && state.fd.bs) r += `è¡€ç³–ï¼š${state.fd.bs} mg/dL\n`;
    if(state.fd.abg_type) {
      r += `è¡€ã‚¬ã‚¹ï¼š${state.fd.abg_type}\n`;
      if(state.fd.abg_data.length > 0) {
        r += state.fd.abg_data.filter(x=>x.val).map(x => `${x.item} ${x.val}${x.unit}`).join(', ') + '\n';
      }
    }
    ['us','ecg','fast','efast'].forEach(t => {
      if(state.fd.exams[t] && state.fd.exam_texts[t]) {
        const labels = {us:'è¶…éŸ³æ³¢',ecg:'12èª˜å°å¿ƒé›»å›³',fast:'FAST',efast:'eFAST'};
        r += `${labels[t]}ï¼š${state.fd.exam_texts[t]}\n`;
      }
    });
    if(state.fd.exam_detail) r += state.fd.exam_detail + '\n';
  }
  
  const fdProc = state.fd.procedures_items.filter(k => state.fd.procedures[k]);
  if(fdProc.length > 0 || state.fd.procedure_detail) {
    r += '\nï¼œå‡¦ç½®ï¼\n';
    if(fdProc.length > 0) r += fdProc.join('ã€') + '\n';
    if(state.fd.procedure_detail) r += state.fd.procedure_detail + '\n';
  }
  
  const fdDrugs = state.fd.drugs_items.filter(k => state.fd.drugs[k]);
  if(fdDrugs.length > 0 || state.fd.drug_detail) {
    r += '\nï¼œè–¬å‰¤ï¼\n';
    if(fdDrugs.length > 0) r += fdDrugs.join('ã€') + '\n';
    if(state.fd.drug_detail) r += state.fd.drug_detail + '\n';
  }
  r += '\n';
  
  r += 'ã€è©•ä¾¡ã€‘\n';
  if(state.problems.length > 0) {
    r += 'ï¼œãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ï¼\n';
    state.problems.forEach((p, i) => r += `#${i+1} ${p}\n`);
  }
  if(state.consideration) r += `ï¼œè€ƒå¯Ÿï¼\n${state.consideration}\n`;
  r += '\n';
  
  r += 'ã€æ¬é€å…ˆã€‘\n';
  const hospitalName = state.destination.custom || state.destination.hospital || 'ï¼ˆæœªé¸æŠï¼‰';
  r += `åŒ»ç™‚æ©Ÿé–¢ï¼š${hospitalName}\n`;
  if(state.destination.reason) r += `é¸å®šç†ç”±ï¼š${state.destination.reason}\n`;
  r += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  r += 'è¨˜éŒ²ä½œæˆï¼š' + new Date().toLocaleString('ja-JP') + '\n';
  
  return r;
}

// ä¿å­˜ãƒ»èª­è¾¼
function saveData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ãƒ˜ãƒªè¨˜éŒ²_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function loadData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          state = JSON.parse(ev.target.result);
          restoreUI();
        } catch(err) { alert('èª­è¾¼ã‚¨ãƒ©ãƒ¼'); }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function resetData() {
  if(!confirm('ã™ã¹ã¦ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  
  // localStorageã‚’ã‚¯ãƒªã‚¢
  localStorage.removeItem('heliRecordV33');
  
  // stateã‚’åˆæœŸåŒ–
  state = {
    request: {type:'', detail:'', time:''},
    patient: {history:'', medication:'', allergy:'', lastMeal:'', hospital:''},
    heli: {takeoff:'', lz_landing:'', fd_contact:'', turn_type:'Iã‚¿ãƒ¼ãƒ³', transport_takeoff:'', hospital_arrival:''},
    ems: {
      aware:'', arrival:'', contact:'', departure:'', lz:'',
      vitals: [],
      exam_tab: 'general',
      chips: {},
      memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{memo:''},cpa:{memo:''}},
      stroke_onset: '',
      procedures: {},
      procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'],
      o2_flow:'', procedures_detail:''
    },
    fd: {
      vitals: [],
      exam_tab: 'general',
      chips: {},
      memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{neuro:'',motor:'',eye:'',higher:''},cpa:{body:'',head:'',trunk:''}},
      exams: {bs:false, us:false, ecg:false, fast:false, efast:false},
      exam_texts: {us:'', ecg:'', fast:'', efast:''},
      bs:120, abg_type:'', abg_data: [], exam_detail:'',
      cpa: {
        arrestTime:'', rhythm:'Asystole', witnessed:false, bystander:false,
        cprStart:'', ivTime:'', adrenalineTimes:[], lt:false,
        intubation:false, intubationTime:'', pericardio:false, pericardioTime:'',
        roscTime:'', memo:''
      },
      stroke: {
        pupilL:3, pupilR:3, plrL:'', plrR:'', gaze:'', nyst:'',
        mmt:{ru:5, lu:5, rl:5, ll:5},
        btr:'', ptr:'', babinski:false, chaddock:false,
        nihss:{}, nihssMemo:''
      },
      procedures: {},
      procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'],
      procedure_detail:'',
      drugs: {},
      drugs_items: ['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹'],
      drug_detail:''
    },
    problems: [],
    consideration: '',
    destination: {hospital:'', custom:'', reason:''},
    hospitals: {
      'é¹¿å…å³¶': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','å—é¢¨ç—…é™¢','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢'],
      'å—è–©': ['æŒ‡å®¿åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ä»Šæ—æ•´å½¢å¤–ç§‘ç—…é™¢','å±±å·ç—…é™¢','å°åŸç—…é™¢','åŠ ä¸–ç”°ç—…é™¢','èŠé‡ç—…é™¢','ä¹…æœ¨ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','çœŒç«‹è–©å—ç—…é™¢','ã‚µã‚¶ãƒ³ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç—…é™¢','åŠæ´¥ç—…é™¢','æ•å´å¸‚ç«‹ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ‰é¦¬ç—…é™¢'],
      'å·è–©': ['æ¸ˆç”Ÿä¼šå·å†…ç—…é™¢','å·å†…å¸‚åŒ»å¸«ä¼šç«‹å¸‚æ°‘ç—…é™¢','å“ç¿”ä¼šè¨˜å¿µç—…é™¢','ä¸Šæ‘ç—…é™¢','é«˜æ±Ÿè¨˜å¿µç—…é™¢','æ£®åœ’è¨˜å¿µç—…é™¢','è‹¥æ¾è¨˜å¿µç—…é™¢','è–©æ‘©éƒ¡åŒ»å¸«ä¼šç—…é™¢'],
      'å‡ºæ°´': ['å‡ºæ°´éƒ¡åŒ»å¸«ä¼šåºƒåŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å‡ºæ°´ç·åˆåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å†…å±±ç—…é™¢'],
      'éœ§å³¶': ['éœ§å³¶å¸‚ç«‹åŒ»å¸«ä¼šåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å›½åˆ†ç”Ÿå”ç—…é™¢','éœ§å³¶è¨˜å¿µç—…é™¢','å¤§äº•ç—…é™¢','åŠ æ²»æœ¨æ•´å½¢å¤–ç§‘ç—…é™¢','åŠ æ²»æœ¨æ¸©æ³‰ç—…é™¢','éœ§å³¶æ‰å®‰ç—…é™¢','éœ§å³¶æ•´å½¢å¤–ç§‘ç—…é™¢','å›½åˆ†ä¸­å¤®ç—…é™¢','å›½åˆ†è„³ç¥çµŒå¤–ç§‘ç—…é™¢','é’é›²ä¼šç—…é™¢','çœŒç«‹åŒ—è–©ç—…é™¢','æ•´å½¢å¤–ç§‘æ¾å…ƒç—…é™¢','å¯ºç”°ç—…é™¢'],
      'æ›½æ–¼': ['æ˜­å—ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯åˆ†é™¢','ã³ã‚ã†ã®æ¨¹è„³ç¥çµŒå¤–ç§‘'],
      'è‚å±': ['çœŒæ°‘å¥åº·ãƒ—ãƒ©ã‚¶é¹¿å±‹åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å¤§éš…é¹¿å±‹ç—…é™¢','æ± ç”°ç—…é™¢','ã‹ã®ã‚„æ±ç—…é™¢','è‚å±éƒ¡åŒ»å¸«ä¼šç«‹ç—…é™¢','è‚ä»˜ç”ºç«‹ç—…é™¢','æ’å¿ƒä¼šãŠãã‚‰ç—…é™¢','å‚æ°´ä¸­å¤®ç—…é™¢','é»æ˜è„³ç¥çµŒå¤–ç§‘åŒ»é™¢','å¾³ç”°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','ã³ã‚ã†ã®æ¨¹'],
      'ç†Šæ¯›': ['ç¨®å­å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å±‹ä¹…å³¶å¾³æ´²ä¼šç—…é™¢'],
      'å¥„ç¾': ['çœŒç«‹å¤§å³¶ç—…é™¢','å¥„ç¾ä¸­å¤®ç—…é™¢','åç€¬å¾³æ´²ä¼šç—…é™¢','ç€¬æˆ¸å†…å¾³æ´²ä¼šç—…é™¢','å¾³ä¹‹å³¶å¾³æ´²ä¼šç—…é™¢','æ²–æ°¸è‰¯éƒ¨å¾³æ´²ä¼šç—…é™¢','å–œç•Œå¾³æ´²ä¼šç—…é™¢','å—æºŸä¼šå®®ä¸Šç—…é™¢','ä¸è«–å¾³æ´²ä¼šç—…é™¢']
    }
  };
  
  // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã«
  location.reload();
}

function restoreUI() {
  $('#request_type').value = state.request.type || '';
  $('#request_detail').value = state.request.detail || '';
  $('#request_time').value = state.request.time || '';
  $('#patient_history').value = state.patient?.history || '';
  $('#patient_medication').value = state.patient?.medication || '';
  $('#patient_allergy').value = state.patient?.allergy || '';
  $('#last_meal_time').value = state.patient?.lastMeal || '';
  $('#patient_hospital').value = state.patient?.hospital || '';
  $('#heli_takeoff').value = state.heli.takeoff || '';
  $('#heli_lz_landing').value = state.heli.lz_landing || '';
  $('#fd_contact').value = state.heli.fd_contact || '';
  $('#turn_type').value = state.heli.turn_type || 'Iã‚¿ãƒ¼ãƒ³';
  $('#transport_takeoff').value = state.heli.transport_takeoff || '';
  $('#hospital_arrival').value = state.heli.hospital_arrival || '';
  $('#transport_times').style.display = state.heli.turn_type !== 'Iã‚¿ãƒ¼ãƒ³' ? 'block' : 'none';
  $('#ems_aware').value = state.ems.aware || '';
  $('#ems_arrival').value = state.ems.arrival || '';
  $('#ems_contact').value = state.ems.contact || '';
  $('#ems_lz').value = state.ems.lz || '';
  $('#ems_o2_flow').value = state.ems.o2_flow || '';
  $('#ems_procedures_detail').value = state.ems.procedures_detail || '';
  if($('#ems_stroke_onset')) $('#ems_stroke_onset').value = state.ems.stroke_onset || '';
  $('#fd_bs').value = state.fd.bs || 120;
  $('#fd_bs_display').textContent = state.fd.bs || 120;
  $('#fd_abg_type').value = state.fd.abg_type || '';
  $('#abg_area').style.display = state.fd.abg_type ? 'block' : 'none';
  
  // è¡€ç³–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  if($('#exam_bs')) {
    $('#exam_bs').checked = state.fd.exams?.bs || false;
    $('#exam_bs_area').style.display = state.fd.exams?.bs ? 'block' : 'none';
  }
  
  ['us','ecg','fast','efast'].forEach(t => {
    $(`#exam_${t}`).checked = state.fd.exams[t] || false;
    $(`#exam_${t}_txt`).style.display = state.fd.exams[t] ? 'block' : 'none';
    $(`#exam_${t}_txt`).value = state.fd.exam_texts[t] || '';
  });
  $('#fd_exam_detail').value = state.fd.exam_detail || '';
  $('#fd_procedure_detail').value = state.fd.procedure_detail || '';
  $('#fd_drug_detail').value = state.fd.drug_detail || '';
  
  // CPAæƒ…å ±å¾©å…ƒ
  renderCpaEvents();
  
  // è„³å’ä¸­æƒ…å ±å¾©å…ƒ
  if(state.fd.stroke && $('#plrL')) {
    $('#pupilL_display').textContent = state.fd.stroke.pupilL || 3;
    $('#pupilR_display').textContent = state.fd.stroke.pupilR || 3;
    $('#plrL').value = state.fd.stroke.plrL || '';
    $('#plrR').value = state.fd.stroke.plrR || '';
    $('#str_gaze').value = state.fd.stroke.gaze || '';
    $('#str_nyst').value = state.fd.stroke.nyst || '';
    if(state.fd.stroke.mmt) {
      $('#mmt_ru_display').textContent = state.fd.stroke.mmt.ru ?? 5;
      $('#mmt_lu_display').textContent = state.fd.stroke.mmt.lu ?? 5;
      $('#mmt_rl_display').textContent = state.fd.stroke.mmt.rl ?? 5;
      $('#mmt_ll_display').textContent = state.fd.stroke.mmt.ll ?? 5;
    }
    $('#str_btr').value = state.fd.stroke.btr || '';
    $('#str_ptr').value = state.fd.stroke.ptr || '';
    $('#str_babinski').checked = state.fd.stroke.babinski || false;
    $('#str_chaddock').checked = state.fd.stroke.chaddock || false;
    if($('#nihss_memo')) $('#nihss_memo').value = state.fd.stroke.nihssMemo || '';
    renderNihss();
  }
  
  $('#consideration').value = state.consideration || '';
  $('#destination_custom').value = state.destination.custom || '';
  $('#selection_reason').value = state.destination.reason || '';
  
  renderEmsVitals();
  renderFdVitals();
  renderProcedureChips('ems_procedures', state.ems.procedures_items, state.ems.procedures);
  renderProcedureChips('fd_procedures', state.fd.procedures_items, state.fd.procedures);
  renderProcedureChips('fd_drugs', state.fd.drugs_items, state.fd.drugs);
  renderAbgPills();
  renderProblems();
  renderHospitalChips();
  bindMemos();
  
  if(state.ems.procedures['é…¸ç´ æŠ•ä¸']) $('#ems_o2_amount').style.display = 'block';
  
  render();
}

// åˆæœŸåŒ–
function init() {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
  const saved = localStorage.getItem('heliRecordV33');
  if(saved) {
    try { state = JSON.parse(saved); } catch(e) {}
  }
  
  // hospitalsã¯å¸¸ã«æœ€æ–°ã®ãƒã‚¹ã‚¿ã‚’ä½¿ç”¨ï¼ˆlocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚“ã å¤ã„å½¢å¼ã‚’ä¸Šæ›¸ãï¼‰
  state.hospitals = {
    'é¹¿å…å³¶': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','å—é¢¨ç—…é™¢','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢'],
    'å—è–©': ['æŒ‡å®¿åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ä»Šæ—æ•´å½¢å¤–ç§‘ç—…é™¢','å±±å·ç—…é™¢','å°åŸç—…é™¢','åŠ ä¸–ç”°ç—…é™¢','èŠé‡ç—…é™¢','ä¹…æœ¨ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','çœŒç«‹è–©å—ç—…é™¢','ã‚µã‚¶ãƒ³ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç—…é™¢','åŠæ´¥ç—…é™¢','æ•å´å¸‚ç«‹ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ‰é¦¬ç—…é™¢'],
    'å·è–©': ['æ¸ˆç”Ÿä¼šå·å†…ç—…é™¢','å·å†…å¸‚åŒ»å¸«ä¼šç«‹å¸‚æ°‘ç—…é™¢','å“ç¿”ä¼šè¨˜å¿µç—…é™¢','ä¸Šæ‘ç—…é™¢','é«˜æ±Ÿè¨˜å¿µç—…é™¢','æ£®åœ’è¨˜å¿µç—…é™¢','è‹¥æ¾è¨˜å¿µç—…é™¢','è–©æ‘©éƒ¡åŒ»å¸«ä¼šç—…é™¢'],
    'å‡ºæ°´': ['å‡ºæ°´éƒ¡åŒ»å¸«ä¼šåºƒåŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å‡ºæ°´ç·åˆåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å†…å±±ç—…é™¢'],
    'éœ§å³¶': ['éœ§å³¶å¸‚ç«‹åŒ»å¸«ä¼šåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å›½åˆ†ç”Ÿå”ç—…é™¢','éœ§å³¶è¨˜å¿µç—…é™¢','å¤§äº•ç—…é™¢','åŠ æ²»æœ¨æ•´å½¢å¤–ç§‘ç—…é™¢','åŠ æ²»æœ¨æ¸©æ³‰ç—…é™¢','éœ§å³¶æ‰å®‰ç—…é™¢','éœ§å³¶æ•´å½¢å¤–ç§‘ç—…é™¢','å›½åˆ†ä¸­å¤®ç—…é™¢','å›½åˆ†è„³ç¥çµŒå¤–ç§‘ç—…é™¢','é’é›²ä¼šç—…é™¢','çœŒç«‹åŒ—è–©ç—…é™¢','æ•´å½¢å¤–ç§‘æ¾å…ƒç—…é™¢','å¯ºç”°ç—…é™¢'],
    'æ›½æ–¼': ['æ˜­å—ç—…é™¢','æ¾å²¡æ•‘æ€¥ã‚¯ãƒªãƒ‹ãƒƒã‚¯åˆ†é™¢','ã³ã‚ã†ã®æ¨¹è„³ç¥çµŒå¤–ç§‘'],
    'è‚å±': ['çœŒæ°‘å¥åº·ãƒ—ãƒ©ã‚¶é¹¿å±‹åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å¤§éš…é¹¿å±‹ç—…é™¢','æ± ç”°ç—…é™¢','ã‹ã®ã‚„æ±ç—…é™¢','è‚å±éƒ¡åŒ»å¸«ä¼šç«‹ç—…é™¢','è‚ä»˜ç”ºç«‹ç—…é™¢','æ’å¿ƒä¼šãŠãã‚‰ç—…é™¢','å‚æ°´ä¸­å¤®ç—…é™¢','é»æ˜è„³ç¥çµŒå¤–ç§‘åŒ»é™¢','å¾³ç”°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','ã³ã‚ã†ã®æ¨¹'],
    'ç†Šæ¯›': ['ç¨®å­å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','å±‹ä¹…å³¶å¾³æ´²ä¼šç—…é™¢'],
    'å¥„ç¾': ['çœŒç«‹å¤§å³¶ç—…é™¢','å¥„ç¾ä¸­å¤®ç—…é™¢','åç€¬å¾³æ´²ä¼šç—…é™¢','ç€¬æˆ¸å†…å¾³æ´²ä¼šç—…é™¢','å¾³ä¹‹å³¶å¾³æ´²ä¼šç—…é™¢','æ²–æ°¸è‰¯éƒ¨å¾³æ´²ä¼šç—…é™¢','å–œç•Œå¾³æ´²ä¼šç—…é™¢','å—æºŸä¼šå®®ä¸Šç—…é™¢','ä¸è«–å¾³æ´²ä¼šç—…é™¢']
  };
  
  // å‡¦ç½®ãƒ»è–¬å‰¤ãƒªã‚¹ãƒˆã‚‚å¸¸ã«æœ€æ–°ãƒã‚¹ã‚¿ã‚’ä½¿ç”¨
  state.ems.procedures_items = ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'];
  state.fd.procedures_items = ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'];
  state.fd.drugs_items = ['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹'];
  
  // ãƒã‚¤ã‚¿ãƒ«åˆæœŸåŒ–
  if(state.ems.vitals.length === 0) addEmsVital();
  if(state.fd.vitals.length === 0) addFdVital();
  
  // ãƒãƒƒãƒ—ãƒã‚¦ãƒ³ãƒˆ
  mountChips('#ems-gen-head', EMS_GEN_GROUPS.head, 'ems');
  mountChips('#ems-gen-resp', EMS_GEN_GROUPS.resp, 'ems');
  mountChips('#ems-gen-card', EMS_GEN_GROUPS.card, 'ems');
  mountChips('#ems-gen-abd', EMS_GEN_GROUPS.abd, 'ems');
  mountChips('#ems-gen-limb', EMS_GEN_GROUPS.limb, 'ems');
  mountChips('#ems-gen-neuro', EMS_GEN_GROUPS.neuro, 'ems');
  mountChips('#ems-tra-head', EMS_TRA_GROUPS.head, 'ems');
  mountChips('#ems-tra-neck', EMS_TRA_GROUPS.neck, 'ems');
  mountChips('#ems-tra-chest', EMS_TRA_GROUPS.chest, 'ems');
  mountChips('#ems-tra-abd', EMS_TRA_GROUPS.abd, 'ems');
  mountChips('#ems-tra-pelvis', EMS_TRA_GROUPS.pelvis, 'ems');
  mountChips('#ems-tra-limb', EMS_TRA_GROUPS.limb, 'ems');
  mountChips('#ems-cpa-rhythm', EMS_CPA_GROUPS.rhythm, 'ems');
  mountChips('#ems-cpa-witness', EMS_CPA_GROUPS.witness, 'ems');
  mountChips('#ems-cpa-airway', EMS_CPA_GROUPS.airway, 'ems');
  mountChips('#ems-cpa-circulation', EMS_CPA_GROUPS.circulation, 'ems');
  mountChips('#ems-cpa-chest', EMS_CPA_GROUPS.chest, 'ems');
  mountChips('#ems-str-conscious', EMS_STR_GROUPS.conscious, 'ems');
  mountChips('#ems-str-face', EMS_STR_GROUPS.face, 'ems');
  mountChips('#ems-str-motor', EMS_STR_GROUPS.motor, 'ems');
  mountChips('#ems-str-other', EMS_STR_GROUPS.other, 'ems');
  
  mountChips('#fd-gen-head', FD_GEN_GROUPS.head, 'fd');
  mountChips('#fd-gen-resp', FD_GEN_GROUPS.resp, 'fd');
  mountChips('#fd-gen-card', FD_GEN_GROUPS.card, 'fd');
  mountChips('#fd-gen-abd', FD_GEN_GROUPS.abd, 'fd');
  mountChips('#fd-gen-limb', FD_GEN_GROUPS.limb, 'fd');
  mountChips('#fd-gen-neuro', FD_GEN_GROUPS.neuro, 'fd');
  mountChips('#fd-tra-head', FD_TRA_GROUPS.head, 'fd');
  mountChips('#fd-tra-neck', FD_TRA_GROUPS.neck, 'fd');
  mountChips('#fd-tra-chest', FD_TRA_GROUPS.chest, 'fd');
  mountChips('#fd-tra-abd', FD_TRA_GROUPS.abd, 'fd');
  mountChips('#fd-tra-pelvis', FD_TRA_GROUPS.pelvis, 'fd');
  mountChips('#fd-tra-limb', FD_TRA_GROUPS.limb, 'fd');
  mountChips('#fd-str-cn', FD_STR_GROUPS.cn, 'fd');
  mountChips('#fd-str-higher', FD_STR_GROUPS.higher, 'fd');
  // FD CPAã¯å°‚ç”¨UIã«å¤‰æ›´ã—ãŸãŸã‚ãƒãƒƒãƒ—ãƒã‚¦ãƒ³ãƒˆãªã—
  
  renderProcedureChips('ems_procedures', state.ems.procedures_items, state.ems.procedures);
  renderProcedureChips('fd_procedures', state.fd.procedures_items, state.fd.procedures);
  renderProcedureChips('fd_drugs', state.fd.drugs_items, state.fd.drugs);
  
  renderHospitalChips();
  renderProblems();
  renderAbgPills();
  renderNihss();
  bindMemos();
  
  setupExamTabs('ems');
  setupExamTabs('fd');
  
  $('#turn_type').onchange = () => {
    $('#transport_times').style.display = $('#turn_type').value !== 'Iã‚¿ãƒ¼ãƒ³' ? 'block' : 'none';
    updateState();
  };
  
  // è‡ªç”±è¨˜è¼‰åŒ»ç™‚æ©Ÿé–¢ã®å…¥åŠ›æ™‚
  $('#destination_custom').oninput = () => updateState();
  
  $('#new_problem').onkeypress = e => { if(e.key === 'Enter') { e.preventDefault(); addProblem(); } };
  
  ['us','ecg','fast','efast'].forEach(t => {
    $(`#exam_${t}_txt`).oninput = () => { state.fd.exam_texts[t] = $(`#exam_${t}_txt`).value; updateState(); };
  });
  
  // stateã«cpaEventsãŒãªã‘ã‚Œã°åˆæœŸåŒ–ï¼ˆæ—§å½¢å¼ã‹ã‚‰ã®ç§»è¡Œã‚‚å«ã‚€ï¼‰
  if(!state.fd.cpaEvents) {
    state.fd.cpaEvents = [];
    // æ—§å½¢å¼ã®state.fd.cpaãŒã‚ã‚Œã°ç§»è¡Œ
    if(state.fd.cpa) {
      state.fd.cpaEvents.push(state.fd.cpa);
      delete state.fd.cpa;
    }
  }
  
  // stateã«patientãŒãªã‘ã‚Œã°åˆæœŸåŒ–
  if(!state.patient) {
    state.patient = {history:'', medication:'', allergy:'', lastMeal:'', hospital:''};
  }
  
  // stateã«exams.bsãŒãªã‘ã‚Œã°åˆæœŸåŒ–
  if(state.fd.exams && state.fd.exams.bs === undefined) {
    state.fd.exams.bs = false;
  }
  
  // stateã«strokeãŒãªã‘ã‚Œã°åˆæœŸåŒ–
  if(!state.fd.stroke) {
    state.fd.stroke = {
      pupilL:3, pupilR:3, plrL:'', plrR:'', gaze:'', nyst:'',
      mmt:{ru:5, lu:5, rl:5, ll:5},
      btr:'', ptr:'', babinski:false, chaddock:false,
      nihss:{}, nihssMemo:''
    };
  }
  
  $$('input, textarea, select').forEach(el => {
    if(!el.onchange && !el.oninput) el.oninput = updateState;
  });
  
  $('#copyOut').onclick = () => {
    navigator.clipboard.writeText($('#outText').textContent).then(() => {
      const btn = $('#copyOut');
      btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
      setTimeout(() => btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼', 2000);
    });
  };
  
  restoreUI();
  render();
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
  $$('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // è¦ªè¦ç´ ã«å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
      const parent = this.closest('.time-row') || this.parentElement;
      if(parent) {
        parent.classList.remove('check-flash');
        // å¼·åˆ¶çš„ã«å†æç”»ã•ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        void parent.offsetWidth;
        parent.classList.add('check-flash');
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        setTimeout(() => parent.classList.remove('check-flash'), 400);
      }
    });
  });
}

init();
</script>
</body>
</html>
